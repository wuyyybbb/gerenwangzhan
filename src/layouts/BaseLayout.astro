---
interface Props {
  title: string;
  description?: string;
  structuredData?: object; // å¯é€‰çš„ç»“æ„åŒ–æ•°æ®
}

const { title, description = "Mythic Engraving Interactive Map Portfolio", structuredData } = Astro.props;
import { ViewTransitions } from 'astro:transitions';
---

<!DOCTYPE html>
<html lang="en" data-astro-prefetch="false">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO Meta Tags -->
    <meta name="description" content={description} />
    <meta name="keywords" content="Wu Yebei, å´å¶è´, AI, äººå·¥æ™ºèƒ½, AIå·¥ä½œæµ, çŸ¥è¯†æ¶æ„, å†³ç­–æ”¯æŒç³»ç»Ÿ, AI Workshop, Knowledge Tower, æ™ºèƒ½åŠ©æ‰‹" />
    <meta name="author" content="Wu Yebei (å´å¶è´)" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:site_name" content="Wu Yebei's Personal Map" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={Astro.url} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <!-- Canonical URL -->
    <link rel="canonical" href={Astro.url} />

    <!-- JSON-LD ç»“æ„åŒ–æ•°æ® for SEO -->
    {structuredData && (
      <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
    )}

    <title>{title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Cinzel:wght@400;600&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- é¦–é¡µèƒŒæ™¯å›¾ preloadï¼ˆå…³é”® LCP èµ„æºï¼‰ -->
    {Astro.url.pathname === '/' && (
      <>
        <link
          rel="preload"
          as="image"
          href="/map/background.webp"
          imagesizes="100vw"
          fetchpriority="high"
        />
        <!-- ğŸ¯ å†…è”å…³é”® CSSï¼šé¿å… FOUC -->
        <style is:inline>
          /* é¦–å±å…³é”®æ ·å¼ï¼šç«‹å³ç”Ÿæ•ˆ */
          .map-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            margin: 0;
            padding: 0;
            background-color: #2a2419;
          }

          /* Placeholder å±‚ï¼šçº¯è‰²èƒŒæ™¯ */
          .map-placeholder {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: linear-gradient(135deg, #3d3225 0%, #2a2419 50%, #1f1810 100%);
            pointer-events: none;
          }

          /* èƒŒæ™¯å›¾ï¼šçº¯ CSS é“ºæ»¡ */
          .map-background {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            object-position: center;
            z-index: 1;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.6s ease-out;
          }

          .map-background.loaded {
            opacity: 1;
          }
        </style>
      </>
    )}

    <ViewTransitions />

    <!-- ğŸµ éŸ³é¢‘å…ƒç´ ï¼ˆpreload="none" ä¸æŠ¢é¦–å±å¸¦å®½ï¼‰ -->
    <script is:inline>
      // åˆå§‹åŒ–å…¨å±€éŸ³é¢‘å¼•ç”¨ï¼ˆåªå¼•ç”¨ DOM å…ƒç´ ï¼Œä¸è‡ªåŠ¨åŠ è½½ï¼‰
      document.addEventListener('DOMContentLoaded', () => {
        if (!window.__globalAudio) {
          const audioElement = document.getElementById('bgm');
          if (audioElement) {
            window.__globalAudio = audioElement;
            window.__globalAudio.loop = true;
            window.__globalAudio.volume = 0.175;
            console.log('ğŸµ å…¨å±€éŸ³é¢‘å…ƒç´ å·²ç»‘å®šï¼ˆæœªåŠ è½½ï¼‰');
          }
        }
      });
    </script>
  </head>
  <body>
    <!-- ğŸµ èƒŒæ™¯éŸ³ä¹ï¼ˆpreload="none" ä¸æŠ¢é¦–å±å¸¦å®½ï¼‰ -->
    <audio id="bgm" preload="none" src="/ambient-music.mp3"></audio>

    <!-- å…¨å±€å·¥å…·æ  -->
    <div class="global-toolbar">
      <!-- æ±‰å ¡èœå• -->
      <button class="hamburger-btn" id="menuToggle" aria-label="Toggle menu">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>

      <nav class="menu-dropdown" id="menuDropdown">
        <a href="/" class="menu-item" data-astro-prefetch="false">
          <span class="menu-item-zh">é¦–é¡µ</span>
          <span class="menu-item-en">Home</span>
        </a>
        <a href="/workshop" class="menu-item" data-astro-prefetch="false">
          <span class="menu-item-zh">AI å®éªŒåŠ</span>
          <span class="menu-item-en">AI Workshop</span>
        </a>
        <a href="/log" class="menu-item" data-astro-prefetch="false">
          <span class="menu-item-zh">çŸ¥è¯†å¡”</span>
          <span class="menu-item-en">Knowledge Tower</span>
        </a>
        <a href="/archives" class="menu-item" data-astro-prefetch="false">
          <span class="menu-item-zh">å¤å·åº“</span>
          <span class="menu-item-en">Ancient Archives</span>
        </a>
        <a href="/command" class="menu-item" data-astro-prefetch="false">
          <span class="menu-item-zh">å†³ç­–ä¸­æ¢</span>
          <span class="menu-item-en">Command Center</span>
        </a>
        <a href="/resume" class="menu-item" data-astro-prefetch="false">
          <span class="menu-item-zh">ç®€å†</span>
          <span class="menu-item-en">Resume</span>
        </a>
      </nav>

      <!-- Debug åˆ‡æ¢æŒ‰é’® -->
      <button class="debug-toggle-btn" id="debugToggle" aria-label="Toggle debug mode">
        <span class="debug-icon">ğŸ”§</span>
      </button>

      <!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶ -->
      <button class="ambient-toggle-btn" id="ambientToggle" aria-label="Toggle ambient music">
        <span class="ambient-icon">ğŸ”Š</span>
      </button>
    </div>

    <slot />

    <!-- ICP å¤‡æ¡ˆå· -->
    <footer class="icp-footer">
      <a
        href="https://beian.miit.gov.cn/#/Integrated/index"
        target="_blank"
        rel="noopener noreferrer"
        class="icp-link"
      >
        æµ™ICPå¤‡2025190152å·-1
      </a>
    </footer>

    <style>
      /* ICP å¤‡æ¡ˆå·æ ·å¼ */
      .icp-footer {
        position: fixed;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        text-align: center;
        pointer-events: none;
      }

      .icp-link {
        font-family: var(--font-sans), sans-serif;
        font-size: 0.75rem;
        color: rgba(74, 74, 74, 0.6);
        text-decoration: none;
        transition: color 0.3s ease;
        pointer-events: all;
        padding: 0.25rem 0.5rem;
      }

      .icp-link:hover {
        color: rgba(74, 74, 74, 0.9);
        text-decoration: underline;
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media (max-width: 768px) {
        .icp-footer {
          bottom: 12px;
        }

        .icp-link {
          font-size: 0.6875rem;
        }
      }

      /* å…¨å±€å·¥å…·æ æ ·å¼ */
      .global-toolbar {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
        pointer-events: none;
      }

      .global-toolbar > * {
        pointer-events: all;
      }

      /* æ±‰å ¡èœå•ï¼ˆå·¦ä¸Šè§’ï¼Œfixed overlayï¼‰ */
      .hamburger-btn {
        position: fixed;
        top: 16px;
        left: 16px;
        z-index: 50;
        background: transparent;
        border: 1px solid var(--ink-main);
        padding: 0.5rem;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 36px;
        height: 36px;
        justify-content: center;
        align-items: center;
        transition: all 0.3s ease;
        opacity: 0.6;
      }

      .hamburger-btn:hover {
        opacity: 1;
        background-color: rgba(31, 31, 31, 0.05);
      }

      .hamburger-line {
        width: 16px;
        height: 1.5px;
        background-color: var(--ink-main);
        transition: all 0.3s ease;
      }

      .hamburger-btn.active .hamburger-line:nth-child(1) {
        transform: translateY(4.5px) rotate(45deg);
      }

      .hamburger-btn.active .hamburger-line:nth-child(2) {
        opacity: 0;
      }

      .hamburger-btn.active .hamburger-line:nth-child(3) {
        transform: translateY(-4.5px) rotate(-45deg);
      }

      .menu-dropdown {
        position: fixed;
        top: 18px; /* åœ¨éŸ³ä¹æŒ‰é’®ä¸‹æ–¹ï¼ˆ108 + 36 + 10pxé—´è·ï¼‰ */
        left: 70px;
        z-index: 50;
        background-color: rgba(239, 233, 198, 0.98);
        border: 1px solid var(--ink-main);
        padding: 0.5rem;
        display: none;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 180px;
        max-height: calc(100vh - 174px); /* è°ƒæ•´æœ€å¤§é«˜åº¦ä»¥é€‚åº”æ–°ä½ç½® */
        overflow-y: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .menu-dropdown.open {
        display: flex;
      }

      .menu-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        border: 1px solid transparent;
        transition: all 0.3s ease;
        text-decoration: none;
        cursor: pointer;
      }

      .menu-item:hover {
        border-color: var(--ink-main);
        background-color: rgba(31, 31, 31, 0.03);
      }

      .menu-item-zh {
        font-family: var(--font-zh-body);
        font-size: 1rem;
        color: var(--ink-main);
        font-weight: 500;
        line-height: 1.4;
      }

      .menu-item-en {
        font-family: 'Inter', var(--font-en-body), sans-serif;
        font-size: 0.75rem;
        color: var(--ink-soft);
        font-weight: 400;
        line-height: 1.2;
        letter-spacing: 0.02em;
        text-transform: capitalize;
      }

      /* Debug åˆ‡æ¢æŒ‰é’®ï¼ˆå·¦ä¸Šè§’ï¼Œfixed overlayï¼‰ */
      .debug-toggle-btn {
        position: fixed;
        top: 62px;
        left: 16px;
        z-index: 50;
        background: transparent;
        border: 1px solid var(--ink-main);
        padding: 0.5rem;
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0.6;
      }

      .debug-toggle-btn:hover {
        opacity: 1;
        background-color: rgba(31, 31, 31, 0.05);
      }

      .debug-toggle-btn.active {
        background-color: rgba(31, 31, 31, 0.1);
        opacity: 1;
      }

      .debug-icon {
        font-size: 0.875rem;
      }

      /* èƒŒæ™¯éŸ³ä¹æŒ‰é’® */
      .ambient-toggle-btn {
        position: fixed;
        top: 108px;
        left: 16px;
        z-index: 50;
        background: transparent;
        border: 1px solid var(--ink-main);
        padding: 0.5rem;
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0.6;
      }

      .ambient-toggle-btn:hover {
        opacity: 1;
        background-color: rgba(31, 31, 31, 0.05);
      }

      .ambient-toggle-btn.playing {
        opacity: 1;
      }

      .ambient-icon {
        font-size: 0.875rem;
        line-height: 1;
        filter: grayscale(1) opacity(0.7);
      }

      .ambient-toggle-btn.playing .ambient-icon {
        animation: musicPulse 1.5s ease-in-out infinite;
      }

      @keyframes musicPulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media (max-width: 768px) {
        .hamburger-btn {
          width: 32px;
          height: 32px;
          top: 12px;
          left: 12px;
          padding: 0.4rem;
          gap: 3px;
        }

        .hamburger-line {
          width: 14px;
          height: 1.5px;
        }

        .menu-dropdown {
          top: 138px; /* ç§»åŠ¨ç«¯ï¼šåœ¨éŸ³ä¹æŒ‰é’®ä¸‹æ–¹ï¼ˆ96 + 32 + 10pxé—´è·ï¼‰ */
          left: 12px;
          max-height: calc(100vh - 158px);
          min-width: 160px;
        }

        .menu-item {
          padding: 0.5rem 0.75rem;
        }

        .menu-item-zh {
          font-size: 0.875rem;
        }

        .menu-item-en {
          font-size: 0.6875rem;
        }

        .debug-toggle-btn {
          width: 32px;
          height: 32px;
          top: 54px;
          left: 12px;
        }

        .debug-icon {
          font-size: 0.75rem;
        }

        .ambient-toggle-btn {
          width: 32px;
          height: 32px;
          top: 96px;
          left: 12px;
          padding: 0.4rem;
        }

        .ambient-icon {
          font-size: 0.75rem;
        }
      }
    </style>

    <script>
      // å…¨å±€å·¥å…·æ è„šæœ¬
      document.addEventListener('astro:page-load', () => {
        console.log('ğŸ“„ é¡µé¢åŠ è½½:', window.location.pathname);

        // è·å–å…¨å±€éŸ³é¢‘å¯¹è±¡
        const ambientMusic = window.__globalAudio;
        if (!ambientMusic) {
          console.error('âŒ å…¨å±€éŸ³é¢‘å¯¹è±¡ä¸å­˜åœ¨ï¼');
          return;
        }

        console.log('ğŸµ å½“å‰éŸ³ä¹çŠ¶æ€:', ambientMusic.paused ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾ä¸­');
        console.log('ğŸ”Š éŸ³é¢‘è¯¦ç»†ä¿¡æ¯:', {
          paused: ambientMusic.paused,
          currentTime: ambientMusic.currentTime,
          duration: ambientMusic.duration,
          volume: ambientMusic.volume,
          loop: ambientMusic.loop,
          readyState: ambientMusic.readyState
        });

        // æ³¨æ„ï¼šä¸è‡ªåŠ¨æ¢å¤æ’­æ”¾ï¼Œå®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶

        // æ±‰å ¡èœå•äº¤äº’
        const menuToggle = document.getElementById('menuToggle');
        const menuDropdown = document.getElementById('menuDropdown');

        if (menuToggle && menuDropdown) {
          // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
          const oldMenuListener = menuToggle._menuListener;
          if (oldMenuListener) {
            menuToggle.removeEventListener('click', oldMenuListener);
          }

          const menuListener = () => {
            menuToggle.classList.toggle('active');
            menuDropdown.classList.toggle('open');
          };

          menuToggle._menuListener = menuListener;
          menuToggle.addEventListener('click', menuListener);

          document.addEventListener('click', (e) => {
            if (!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) {
              menuToggle.classList.remove('active');
              menuDropdown.classList.remove('open');
            }
          });

          const menuItems = menuDropdown.querySelectorAll('.menu-item');
          menuItems.forEach(item => {
            item.addEventListener('click', () => {
              menuToggle.classList.remove('active');
              menuDropdown.classList.remove('open');
            });
          });
        }

        // Debug åˆ‡æ¢ï¼ˆä»…åœ¨é¦–é¡µæœ‰debugå±‚æ—¶æ‰ç”Ÿæ•ˆï¼‰
        const debugToggle = document.getElementById('debugToggle');
        const debugLayer = document.getElementById('debugLayer');

        if (debugToggle) {
          // ç§»é™¤æ—§çš„ç›‘å¬å™¨
          const oldDebugListener = debugToggle._debugListener;
          if (oldDebugListener) {
            debugToggle.removeEventListener('click', oldDebugListener);
          }

          let debugMode = false;

          const debugListener = () => {
            debugMode = !debugMode;
            debugToggle.classList.toggle('active', debugMode);

            if (debugLayer) {
              debugLayer.classList.toggle('visible', debugMode);
            }

            if (debugMode) {
              console.log('=== Debug Mode Enabled ===');
            }
          };

          debugToggle._debugListener = debugListener;
          debugToggle.addEventListener('click', debugListener);

          // é”®ç›˜å¿«æ·é”®ï¼šD é”®åˆ‡æ¢ debug
          document.addEventListener('keydown', (e) => {
            if (e.key === 'd' || e.key === 'D') {
              debugToggle.click();
            }
          });
        }

        // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
        const ambientToggle = document.getElementById('ambientToggle');

        if (ambientToggle) {
          console.log('ğŸ›ï¸ æ‰¾åˆ°éŸ³ä¹æŒ‰é’®ï¼ŒåŒæ­¥æŒ‰é’®çŠ¶æ€...');

          // åŒæ­¥æŒ‰é’®çŠ¶æ€
          if (!ambientMusic.paused) {
            console.log('âœ… éŸ³ä¹æ­£åœ¨æ’­æ”¾ï¼Œæ·»åŠ  playing ç±»');
            ambientToggle.classList.add('playing');
          } else {
            console.log('â¸ï¸ éŸ³ä¹å·²æš‚åœï¼Œç§»é™¤ playing ç±»');
            ambientToggle.classList.remove('playing');
          }

          // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
          const oldClickListener = ambientToggle._clickListener;
          if (oldClickListener) {
            ambientToggle.removeEventListener('click', oldClickListener);
          }

          // åˆ›å»ºç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
          const clickListener = async () => {
            try {
              if (ambientMusic.paused) {
                console.log('ğŸµ ç”¨æˆ·å¼€å¯éŸ³ä¹');

                // ğŸ¯ é¦–æ¬¡ç‚¹å‡»æ—¶ï¼šå…ˆæ£€æŸ¥æ˜¯å¦éœ€è¦åŠ è½½éŸ³é¢‘
                if (ambientMusic.readyState === 0) {
                  console.log('ğŸ“¥ é¦–æ¬¡åŠ è½½éŸ³é¢‘æ–‡ä»¶...');
                  ambientMusic.load();
                }

                // æ¢å¤ä¹‹å‰çš„æ’­æ”¾ä½ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
                const savedTime = parseFloat(localStorage.getItem('musicTime') || '0');
                if (savedTime > 0 && ambientMusic.readyState >= 1) {
                  ambientMusic.currentTime = savedTime;
                  console.log('â±ï¸ æ¢å¤æ’­æ”¾ä½ç½®åˆ°:', savedTime);
                }

                await ambientMusic.play();
                ambientToggle.classList.add('playing');
                localStorage.setItem('musicPlaying', 'true');
              } else {
                console.log('â¸ï¸ ç”¨æˆ·æš‚åœéŸ³ä¹');
                ambientMusic.pause();
                ambientToggle.classList.remove('playing');
                localStorage.setItem('musicPlaying', 'false');
                localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
              }
            } catch (err) {
              console.error('âŒ éŸ³é¢‘æ“ä½œå¤±è´¥:', err);
            }
          };

          // ä¿å­˜å¹¶æ·»åŠ ç›‘å¬å™¨
          ambientToggle._clickListener = clickListener;
          ambientToggle.addEventListener('click', clickListener);
        }

        // ç›‘å¬éŸ³é¢‘äº‹ä»¶ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
        if (!window.__audioEventsAdded) {
          console.log('ğŸ§ æ·»åŠ éŸ³é¢‘äº‹ä»¶ç›‘å¬å™¨');

          ambientMusic.addEventListener('play', () => {
            console.log('â–¶ï¸ éŸ³é¢‘å¼€å§‹æ’­æ”¾');
            localStorage.setItem('musicPlaying', 'true');
            document.querySelectorAll('.ambient-toggle-btn').forEach(btn => {
              btn.classList.add('playing');
            });

            // æ’­æ”¾æ—¶å®šæœŸä¿å­˜è¿›åº¦
            if (!window.__musicSaveInterval) {
              window.__musicSaveInterval = setInterval(() => {
                if (!ambientMusic.paused) {
                  localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
                }
              }, 1000);
            }
          });

          ambientMusic.addEventListener('pause', () => {
            console.log('â¸ï¸ éŸ³é¢‘å·²æš‚åœ');
            localStorage.setItem('musicPlaying', 'false');
            localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
            document.querySelectorAll('.ambient-toggle-btn').forEach(btn => {
              btn.classList.remove('playing');
            });

            // åœæ­¢å®šæœŸä¿å­˜
            if (window.__musicSaveInterval) {
              clearInterval(window.__musicSaveInterval);
              window.__musicSaveInterval = null;
            }
          });

          ambientMusic.addEventListener('ended', () => {
            console.log('â¹ï¸ éŸ³é¢‘æ’­æ”¾ç»“æŸï¼ˆå¾ªç¯æ¨¡å¼ä¸‹ä¸åº”è¯¥å‘ç”Ÿï¼‰');
            localStorage.setItem('musicPlaying', 'false');
            localStorage.setItem('musicTime', '0');
            document.querySelectorAll('.ambient-toggle-btn').forEach(btn => {
              btn.classList.remove('playing');
            });
          });

          window.__audioEventsAdded = true;
        }
      });

      // ç›‘å¬é¡µé¢åˆ‡æ¢äº‹ä»¶
      document.addEventListener('astro:before-preparation', () => {
        const ambientMusic = window.__globalAudio;
        if (ambientMusic) {
          console.log('ğŸ”„ é¡µé¢å³å°†åˆ‡æ¢ï¼ŒéŸ³ä¹çŠ¶æ€:', ambientMusic.paused ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾ä¸­');
          // ä¿å­˜å½“å‰çŠ¶æ€
          if (!ambientMusic.paused) {
            localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
            localStorage.setItem('musicPlaying', 'true');
          }
        }
      });

      document.addEventListener('astro:after-swap', () => {
        const ambientMusic = window.__globalAudio;
        if (ambientMusic) {
          console.log('âœ… é¡µé¢åˆ‡æ¢å®Œæˆï¼ˆafter-swapï¼‰ï¼ŒéŸ³ä¹çŠ¶æ€:', ambientMusic.paused ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾ä¸­');
          // æ³¨æ„ï¼šä¸è‡ªåŠ¨æ¢å¤æ’­æ”¾ï¼Œå®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶
        }
      });

      // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
      window.addEventListener('beforeunload', () => {
        const ambientMusic = window.__globalAudio;
        if (ambientMusic && !ambientMusic.paused) {
          console.log('ğŸ’¾ é¡µé¢å¸è½½ï¼Œä¿å­˜éŸ³ä¹çŠ¶æ€');
          localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
          localStorage.setItem('musicPlaying', 'true');
        }
      });

      // é¡µé¢éšè—æ—¶ä¿å­˜çŠ¶æ€
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          const ambientMusic = window.__globalAudio;
          if (ambientMusic && !ambientMusic.paused) {
            console.log('ğŸ‘ï¸ é¡µé¢éšè—ï¼Œä¿å­˜éŸ³ä¹çŠ¶æ€');
            localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
            localStorage.setItem('musicPlaying', 'true');
          }
        }
      });
    </script>

    <script is:inline>
      (() => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('no_track') === '1') return;
        if (window.location.pathname.startsWith('/admin')) return;

        const sessionKey = 'pm_session_id';
        let sessionId = localStorage.getItem(sessionKey);
        if (!sessionId) {
          sessionId = (crypto?.randomUUID?.() || `${Date.now()}-${Math.random().toString(16).slice(2)}`);
          localStorage.setItem(sessionKey, sessionId);
        }

        const payloadBase = {
          session_id: sessionId,
          path: window.location.pathname,
          href: window.location.href,
          ref: document.referrer || '',
          ua: navigator.userAgent || '',
        };

        const sendEvent = (event) => {
          const data = JSON.stringify({ ...payloadBase, event });
          try {
            const blob = new Blob([data], { type: 'application/json' });
            if (navigator.sendBeacon && navigator.sendBeacon('/api/track', blob)) {
              return;
            }
          } catch (err) {
            // å‘é€å¤±è´¥æ—¶é™çº§ä¸º fetch
          }
          try {
            fetch('/api/track', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: data,
              keepalive: true,
            }).catch(() => {});
          } catch (err) {
            // é™é»˜å¤±è´¥ï¼Œä¸å½±å“é¡µé¢
          }
        };

        let lastHeartbeat = 0;
        const heartbeatInterval = 15000;
        const sendHeartbeat = () => {
          const now = Date.now();
          if (now - lastHeartbeat < heartbeatInterval - 1000) return;
          lastHeartbeat = now;
          sendEvent('heartbeat');
        };

        sendEvent('page_view');
        const timer = setInterval(sendHeartbeat, heartbeatInterval);

        let leaveSent = false;
        const sendLeave = () => {
          if (leaveSent) return;
          leaveSent = true;
          clearInterval(timer);
          sendEvent('leave');
        };

        window.addEventListener('pagehide', sendLeave, { once: true });
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'hidden') {
            sendLeave();
          }
        });
      })();
    </script>
  </body>
</html>
