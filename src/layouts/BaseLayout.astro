---
interface Props {
  title: string;
  description?: string;
}

const { title, description = "Mythic Engraving Interactive Map Portfolio" } = Astro.props;
import { ViewTransitions } from 'astro:transitions';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <title>{title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Cinzel:wght@400;600&family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <ViewTransitions />

    <!-- åœ¨é¡µé¢åŠ è½½å‰åˆ›å»ºå…¨å±€éŸ³é¢‘å¯¹è±¡ -->
    <script is:inline>
      // åˆ›å»ºå…¨å±€éŸ³é¢‘å¯¹è±¡ï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼‰
      if (!window.__globalAudio) {
        console.log('ğŸµ åˆå§‹åŒ–å…¨å±€éŸ³é¢‘å¯¹è±¡');
        window.__globalAudio = new Audio('/ambient-music.mp3');
        window.__globalAudio.loop = true;
        window.__globalAudio.volume = 0.175;

        // æ£€æŸ¥ localStorage ä¸­çš„æ’­æ”¾çŠ¶æ€
        const wasPlaying = localStorage.getItem('musicPlaying') === 'true';
        const savedTime = parseFloat(localStorage.getItem('musicTime') || '0');

        console.log('ğŸ’¾ ä» localStorage è¯»å–çŠ¶æ€:', { wasPlaying, savedTime });

        if (wasPlaying) {
          // æ¢å¤æ’­æ”¾ä½ç½®
          if (savedTime > 0) {
            window.__globalAudio.currentTime = savedTime;
          }

          // å°è¯•è‡ªåŠ¨æ¢å¤æ’­æ”¾
          window.__globalAudio.play().then(() => {
            console.log('âœ… éŸ³ä¹å·²è‡ªåŠ¨æ¢å¤æ’­æ”¾');
            window.__pendingMusicResume = false;
          }).catch(err => {
            console.log('âš ï¸ è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰:', err.message);
            // æ ‡è®°éœ€è¦åœ¨ä¸‹æ¬¡ç”¨æˆ·äº¤äº’æ—¶æ¢å¤æ’­æ”¾
            window.__pendingMusicResume = true;
          });
        }

        // å®šæœŸä¿å­˜æ’­æ”¾çŠ¶æ€åˆ° localStorage
        setInterval(() => {
          if (!window.__globalAudio.paused) {
            localStorage.setItem('musicTime', window.__globalAudio.currentTime.toString());
            localStorage.setItem('musicPlaying', 'true');
          }
        }, 1000);

        // æ ‡è®°å·²åˆå§‹åŒ–
        window.__globalAudioInitialized = true;
      }

      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç›‘å¬ç”¨æˆ·äº¤äº’ï¼Œæ¢å¤è¢«é˜»æ­¢çš„éŸ³ä¹æ’­æ”¾
      // å°†å‡½æ•°æ”¾åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œç¡®ä¿åªæ·»åŠ ä¸€æ¬¡ç›‘å¬å™¨
      if (!window.__musicInteractionListenerAdded) {
        const resumeMusicOnInteraction = () => {
          // æ¯æ¬¡ç”¨æˆ·äº¤äº’æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤éŸ³ä¹
          if (window.__pendingMusicResume && window.__globalAudio) {
            const shouldBePlaying = localStorage.getItem('musicPlaying') === 'true';
            if (shouldBePlaying && window.__globalAudio.paused) {
              console.log('ğŸ¯ æ£€æµ‹åˆ°ç”¨æˆ·äº¤äº’ï¼Œå°è¯•æ¢å¤éŸ³ä¹...');
              window.__globalAudio.play().then(() => {
                console.log('âœ… éŸ³ä¹å·²é€šè¿‡ç”¨æˆ·äº¤äº’æ¢å¤');
                window.__pendingMusicResume = false;
              }).catch(err => {
                console.error('âŒ æ¢å¤æ’­æ”¾ä»ç„¶å¤±è´¥:', err);
              });
            }
          }
        };

        // æ·»åŠ å¤šç§ç”¨æˆ·äº¤äº’ç›‘å¬ï¼ˆæ°¸ä¹…å­˜åœ¨ï¼Œä¸ç§»é™¤ï¼‰
        document.addEventListener('click', resumeMusicOnInteraction);
        document.addEventListener('touchstart', resumeMusicOnInteraction);
        document.addEventListener('keydown', resumeMusicOnInteraction);

        window.__musicInteractionListenerAdded = true;
        console.log('ğŸ§ ç”¨æˆ·äº¤äº’ç›‘å¬å™¨å·²è®¾ç½®ï¼ˆå…¨å±€ï¼Œæ°¸ä¹…ï¼‰');
      }
    </script>
  </head>
  <body>
    <!-- å…¨å±€å·¥å…·æ  -->
    <div class="global-toolbar">
      <!-- æ±‰å ¡èœå• -->
      <button class="hamburger-btn" id="menuToggle" aria-label="Toggle menu">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>

      <nav class="menu-dropdown" id="menuDropdown">
        <a href="/" class="menu-item">
          <span class="menu-item-zh">é¦–é¡µ</span>
          <span class="menu-item-en">Home</span>
        </a>
        <a href="/workshop" class="menu-item">
          <span class="menu-item-zh">AI å®éªŒåŠ</span>
          <span class="menu-item-en">AI Workshop</span>
        </a>
        <a href="/log" class="menu-item">
          <span class="menu-item-zh">çŸ¥è¯†å¡”</span>
          <span class="menu-item-en">Knowledge Tower</span>
        </a>
        <a href="/archives" class="menu-item">
          <span class="menu-item-zh">å¤å·åº“</span>
          <span class="menu-item-en">Ancient Archives</span>
        </a>
        <a href="/command" class="menu-item">
          <span class="menu-item-zh">å†³ç­–ä¸­æ¢</span>
          <span class="menu-item-en">Command Center</span>
        </a>
        <a href="/resume" class="menu-item">
          <span class="menu-item-zh">ç®€å†</span>
          <span class="menu-item-en">Resume</span>
        </a>
      </nav>

      <!-- Debug åˆ‡æ¢æŒ‰é’® -->
      <button class="debug-toggle-btn" id="debugToggle" aria-label="Toggle debug mode">
        <span class="debug-icon">ğŸ”§</span>
      </button>

      <!-- èƒŒæ™¯éŸ³ä¹æ§åˆ¶ -->
      <button class="ambient-toggle-btn" id="ambientToggle" aria-label="Toggle ambient music">
        <span class="ambient-icon">ğŸ”Š</span>
      </button>
    </div>

    <slot />

    <style>
      /* å…¨å±€å·¥å…·æ æ ·å¼ */
      .global-toolbar {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
        pointer-events: none;
      }

      .global-toolbar > * {
        pointer-events: all;
      }

      /* æ±‰å ¡èœå•ï¼ˆå·¦ä¸Šè§’ï¼Œfixed overlayï¼‰ */
      .hamburger-btn {
        position: fixed;
        top: 16px;
        left: 16px;
        z-index: 50;
        background: transparent;
        border: 1px solid var(--ink-main);
        padding: 0.5rem;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 36px;
        height: 36px;
        justify-content: center;
        align-items: center;
        transition: all 0.3s ease;
        opacity: 0.6;
      }

      .hamburger-btn:hover {
        opacity: 1;
        background-color: rgba(31, 31, 31, 0.05);
      }

      .hamburger-line {
        width: 16px;
        height: 1.5px;
        background-color: var(--ink-main);
        transition: all 0.3s ease;
      }

      .hamburger-btn.active .hamburger-line:nth-child(1) {
        transform: translateY(4.5px) rotate(45deg);
      }

      .hamburger-btn.active .hamburger-line:nth-child(2) {
        opacity: 0;
      }

      .hamburger-btn.active .hamburger-line:nth-child(3) {
        transform: translateY(-4.5px) rotate(-45deg);
      }

      .menu-dropdown {
        position: fixed;
        top: 18px; /* åœ¨éŸ³ä¹æŒ‰é’®ä¸‹æ–¹ï¼ˆ108 + 36 + 10pxé—´è·ï¼‰ */
        left: 70px;
        z-index: 50;
        background-color: rgba(239, 233, 198, 0.98);
        border: 1px solid var(--ink-main);
        padding: 0.5rem;
        display: none;
        flex-direction: column;
        gap: 0.5rem;
        min-width: 180px;
        max-height: calc(100vh - 174px); /* è°ƒæ•´æœ€å¤§é«˜åº¦ä»¥é€‚åº”æ–°ä½ç½® */
        overflow-y: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .menu-dropdown.open {
        display: flex;
      }

      .menu-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        border: 1px solid transparent;
        transition: all 0.3s ease;
        text-decoration: none;
        cursor: pointer;
      }

      .menu-item:hover {
        border-color: var(--ink-main);
        background-color: rgba(31, 31, 31, 0.03);
      }

      .menu-item-zh {
        font-family: var(--font-zh-body);
        font-size: 1rem;
        color: var(--ink-main);
        font-weight: 500;
        line-height: 1.4;
      }

      .menu-item-en {
        font-family: 'Inter', var(--font-en-body), sans-serif;
        font-size: 0.75rem;
        color: var(--ink-soft);
        font-weight: 400;
        line-height: 1.2;
        letter-spacing: 0.02em;
        text-transform: capitalize;
      }

      /* Debug åˆ‡æ¢æŒ‰é’®ï¼ˆå·¦ä¸Šè§’ï¼Œfixed overlayï¼‰ */
      .debug-toggle-btn {
        position: fixed;
        top: 62px;
        left: 16px;
        z-index: 50;
        background: transparent;
        border: 1px solid var(--ink-main);
        padding: 0.5rem;
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0.6;
      }

      .debug-toggle-btn:hover {
        opacity: 1;
        background-color: rgba(31, 31, 31, 0.05);
      }

      .debug-toggle-btn.active {
        background-color: rgba(31, 31, 31, 0.1);
        opacity: 1;
      }

      .debug-icon {
        font-size: 0.875rem;
      }

      /* èƒŒæ™¯éŸ³ä¹æŒ‰é’® */
      .ambient-toggle-btn {
        position: fixed;
        top: 108px;
        left: 16px;
        z-index: 50;
        background: transparent;
        border: 1px solid var(--ink-main);
        padding: 0.5rem;
        cursor: pointer;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        opacity: 0.6;
      }

      .ambient-toggle-btn:hover {
        opacity: 1;
        background-color: rgba(31, 31, 31, 0.05);
      }

      .ambient-toggle-btn.playing {
        opacity: 1;
      }

      .ambient-icon {
        font-size: 0.875rem;
        line-height: 1;
        filter: grayscale(1) opacity(0.7);
      }

      .ambient-toggle-btn.playing .ambient-icon {
        animation: musicPulse 1.5s ease-in-out infinite;
      }

      @keyframes musicPulse {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      /* å“åº”å¼è°ƒæ•´ */
      @media (max-width: 768px) {
        .hamburger-btn {
          width: 32px;
          height: 32px;
          top: 12px;
          left: 12px;
          padding: 0.4rem;
          gap: 3px;
        }

        .hamburger-line {
          width: 14px;
          height: 1.5px;
        }

        .menu-dropdown {
          top: 138px; /* ç§»åŠ¨ç«¯ï¼šåœ¨éŸ³ä¹æŒ‰é’®ä¸‹æ–¹ï¼ˆ96 + 32 + 10pxé—´è·ï¼‰ */
          left: 12px;
          max-height: calc(100vh - 158px);
          min-width: 160px;
        }

        .menu-item {
          padding: 0.5rem 0.75rem;
        }

        .menu-item-zh {
          font-size: 0.875rem;
        }

        .menu-item-en {
          font-size: 0.6875rem;
        }

        .debug-toggle-btn {
          width: 32px;
          height: 32px;
          top: 54px;
          left: 12px;
        }

        .debug-icon {
          font-size: 0.75rem;
        }

        .ambient-toggle-btn {
          width: 32px;
          height: 32px;
          top: 96px;
          left: 12px;
          padding: 0.4rem;
        }

        .ambient-icon {
          font-size: 0.75rem;
        }
      }
    </style>

    <script>
      // å…¨å±€å·¥å…·æ è„šæœ¬
      document.addEventListener('astro:page-load', () => {
        console.log('ğŸ“„ é¡µé¢åŠ è½½:', window.location.pathname);

        // è·å–å…¨å±€éŸ³é¢‘å¯¹è±¡
        const ambientMusic = window.__globalAudio;
        if (!ambientMusic) {
          console.error('âŒ å…¨å±€éŸ³é¢‘å¯¹è±¡ä¸å­˜åœ¨ï¼');
          return;
        }

        console.log('ğŸµ å½“å‰éŸ³ä¹çŠ¶æ€:', ambientMusic.paused ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾ä¸­');
        console.log('ğŸ”Š éŸ³é¢‘è¯¦ç»†ä¿¡æ¯:', {
          paused: ambientMusic.paused,
          currentTime: ambientMusic.currentTime,
          duration: ambientMusic.duration,
          volume: ambientMusic.volume,
          loop: ambientMusic.loop
        });

        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ¯æ¬¡é¡µé¢åŠ è½½æ—¶ï¼Œæ£€æŸ¥ localStorage å¹¶ç¡®ä¿éŸ³ä¹çŠ¶æ€æ­£ç¡®
        const shouldBePlaying = localStorage.getItem('musicPlaying') === 'true';
        console.log('ğŸ’¾ localStorage æ˜¾ç¤ºéŸ³ä¹åº”è¯¥:', shouldBePlaying ? 'æ’­æ”¾' : 'æš‚åœ');

        if (shouldBePlaying && ambientMusic.paused) {
          // localStorage è¯´åº”è¯¥æ’­æ”¾ï¼Œä½†å®é™…æš‚åœäº†ï¼Œå°è¯•æ¢å¤æ’­æ”¾
          console.log('ğŸ”§ æ£€æµ‹åˆ°éŸ³ä¹åº”è¯¥æ’­æ”¾ä½†å·²æš‚åœï¼Œæ­£åœ¨æ¢å¤...');
          const savedTime = parseFloat(localStorage.getItem('musicTime') || '0');
          if (savedTime > 0 && Math.abs(ambientMusic.currentTime - savedTime) > 2) {
            ambientMusic.currentTime = savedTime;
            console.log('â±ï¸ æ¢å¤æ’­æ”¾ä½ç½®åˆ°:', savedTime);
          }
          ambientMusic.play().then(() => {
            console.log('âœ… éŸ³ä¹å·²æˆåŠŸæ¢å¤æ’­æ”¾');
            window.__pendingMusicResume = false;
          }).catch(err => {
            console.error('âŒ æ¢å¤æ’­æ”¾å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰:', err);
            // æ ‡è®°éœ€è¦åœ¨ç”¨æˆ·äº¤äº’æ—¶æ¢å¤
            window.__pendingMusicResume = true;
          });
        } else if (!shouldBePlaying && !ambientMusic.paused) {
          // localStorage è¯´åº”è¯¥æš‚åœï¼Œä½†å®é™…åœ¨æ’­æ”¾ï¼Œæš‚åœå®ƒ
          console.log('ğŸ”§ æ£€æµ‹åˆ°éŸ³ä¹åº”è¯¥æš‚åœä½†æ­£åœ¨æ’­æ”¾ï¼Œæ­£åœ¨æš‚åœ...');
          ambientMusic.pause();
        } else {
          console.log('âœ… éŸ³ä¹çŠ¶æ€ä¸ localStorage ä¸€è‡´ï¼Œæ— éœ€è°ƒæ•´');
        }

        // æ±‰å ¡èœå•äº¤äº’
        const menuToggle = document.getElementById('menuToggle');
        const menuDropdown = document.getElementById('menuDropdown');

        if (menuToggle && menuDropdown) {
          // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
          const oldMenuListener = menuToggle._menuListener;
          if (oldMenuListener) {
            menuToggle.removeEventListener('click', oldMenuListener);
          }

          const menuListener = () => {
            menuToggle.classList.toggle('active');
            menuDropdown.classList.toggle('open');
          };

          menuToggle._menuListener = menuListener;
          menuToggle.addEventListener('click', menuListener);

          document.addEventListener('click', (e) => {
            if (!menuToggle.contains(e.target) && !menuDropdown.contains(e.target)) {
              menuToggle.classList.remove('active');
              menuDropdown.classList.remove('open');
            }
          });

          const menuItems = menuDropdown.querySelectorAll('.menu-item');
          menuItems.forEach(item => {
            item.addEventListener('click', () => {
              menuToggle.classList.remove('active');
              menuDropdown.classList.remove('open');
            });
          });
        }

        // Debug åˆ‡æ¢ï¼ˆä»…åœ¨é¦–é¡µæœ‰debugå±‚æ—¶æ‰ç”Ÿæ•ˆï¼‰
        const debugToggle = document.getElementById('debugToggle');
        const debugLayer = document.getElementById('debugLayer');

        if (debugToggle) {
          // ç§»é™¤æ—§çš„ç›‘å¬å™¨
          const oldDebugListener = debugToggle._debugListener;
          if (oldDebugListener) {
            debugToggle.removeEventListener('click', oldDebugListener);
          }

          let debugMode = false;

          const debugListener = () => {
            debugMode = !debugMode;
            debugToggle.classList.toggle('active', debugMode);

            if (debugLayer) {
              debugLayer.classList.toggle('visible', debugMode);
            }

            if (debugMode) {
              console.log('=== Debug Mode Enabled ===');
            }
          };

          debugToggle._debugListener = debugListener;
          debugToggle.addEventListener('click', debugListener);

          // é”®ç›˜å¿«æ·é”®ï¼šD é”®åˆ‡æ¢ debug
          document.addEventListener('keydown', (e) => {
            if (e.key === 'd' || e.key === 'D') {
              debugToggle.click();
            }
          });
        }

        // èƒŒæ™¯éŸ³ä¹æ§åˆ¶
        const ambientToggle = document.getElementById('ambientToggle');

        if (ambientToggle) {
          console.log('ğŸ›ï¸ æ‰¾åˆ°éŸ³ä¹æŒ‰é’®ï¼ŒåŒæ­¥æŒ‰é’®çŠ¶æ€...');

          // åŒæ­¥æŒ‰é’®çŠ¶æ€
          if (!ambientMusic.paused) {
            console.log('âœ… éŸ³ä¹æ­£åœ¨æ’­æ”¾ï¼Œæ·»åŠ  playing ç±»');
            ambientToggle.classList.add('playing');
          } else {
            console.log('â¸ï¸ éŸ³ä¹å·²æš‚åœï¼Œç§»é™¤ playing ç±»');
            ambientToggle.classList.remove('playing');
          }

          // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
          const oldClickListener = ambientToggle._clickListener;
          if (oldClickListener) {
            ambientToggle.removeEventListener('click', oldClickListener);
          }

          // åˆ›å»ºç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
          const clickListener = async () => {
            try {
              if (ambientMusic.paused) {
                console.log('ğŸµ ç”¨æˆ·å¼€å¯éŸ³ä¹');
                await ambientMusic.play();
                ambientToggle.classList.add('playing');
                localStorage.setItem('musicPlaying', 'true');
              } else {
                console.log('â¸ï¸ ç”¨æˆ·æš‚åœéŸ³ä¹');
                ambientMusic.pause();
                ambientToggle.classList.remove('playing');
                localStorage.setItem('musicPlaying', 'false');
                localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
              }
            } catch (err) {
              console.error('âŒ éŸ³é¢‘æ“ä½œå¤±è´¥:', err);
            }
          };

          // ä¿å­˜å¹¶æ·»åŠ ç›‘å¬å™¨
          ambientToggle._clickListener = clickListener;
          ambientToggle.addEventListener('click', clickListener);
        }

        // ç›‘å¬éŸ³é¢‘äº‹ä»¶ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
        if (!window.__audioEventsAdded) {
          console.log('ğŸ§ æ·»åŠ éŸ³é¢‘äº‹ä»¶ç›‘å¬å™¨');

          ambientMusic.addEventListener('play', () => {
            console.log('â–¶ï¸ éŸ³é¢‘å¼€å§‹æ’­æ”¾');
            localStorage.setItem('musicPlaying', 'true');
            document.querySelectorAll('.ambient-toggle-btn').forEach(btn => {
              btn.classList.add('playing');
            });
          });

          ambientMusic.addEventListener('pause', () => {
            console.log('â¸ï¸ éŸ³é¢‘å·²æš‚åœ');
            localStorage.setItem('musicPlaying', 'false');
            localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
            document.querySelectorAll('.ambient-toggle-btn').forEach(btn => {
              btn.classList.remove('playing');
            });
          });

          ambientMusic.addEventListener('ended', () => {
            console.log('â¹ï¸ éŸ³é¢‘æ’­æ”¾ç»“æŸï¼ˆå¾ªç¯æ¨¡å¼ä¸‹ä¸åº”è¯¥å‘ç”Ÿï¼‰');
            localStorage.setItem('musicPlaying', 'false');
            localStorage.setItem('musicTime', '0');
            document.querySelectorAll('.ambient-toggle-btn').forEach(btn => {
              btn.classList.remove('playing');
            });
          });

          window.__audioEventsAdded = true;
        }
      });

      // ç›‘å¬é¡µé¢åˆ‡æ¢äº‹ä»¶
      document.addEventListener('astro:before-preparation', () => {
        const ambientMusic = window.__globalAudio;
        if (ambientMusic) {
          console.log('ğŸ”„ é¡µé¢å³å°†åˆ‡æ¢ï¼ŒéŸ³ä¹çŠ¶æ€:', ambientMusic.paused ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾ä¸­');
          // ä¿å­˜å½“å‰çŠ¶æ€
          if (!ambientMusic.paused) {
            localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
            localStorage.setItem('musicPlaying', 'true');
          }
        }
      });

      document.addEventListener('astro:after-swap', () => {
        const ambientMusic = window.__globalAudio;
        if (ambientMusic) {
          console.log('âœ… é¡µé¢åˆ‡æ¢å®Œæˆï¼ˆafter-swapï¼‰ï¼ŒéŸ³ä¹çŠ¶æ€:', ambientMusic.paused ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾ä¸­');

          // ğŸ”¥ å…³é”®ä¿®å¤ï¼šåœ¨ after-swap æ—¶ä¹Ÿæ£€æŸ¥å¹¶æ¢å¤éŸ³ä¹çŠ¶æ€ï¼ˆå¤„ç†æµè§ˆå™¨åé€€/å‰è¿›æŒ‰é’®ï¼‰
          const shouldBePlaying = localStorage.getItem('musicPlaying') === 'true';
          console.log('ğŸ’¾ [after-swap] localStorage æ˜¾ç¤ºéŸ³ä¹åº”è¯¥:', shouldBePlaying ? 'æ’­æ”¾' : 'æš‚åœ');

          if (shouldBePlaying && ambientMusic.paused) {
            console.log('ğŸ”§ [after-swap] æ£€æµ‹åˆ°éŸ³ä¹åº”è¯¥æ’­æ”¾ä½†å·²æš‚åœï¼Œæ­£åœ¨æ¢å¤...');
            const savedTime = parseFloat(localStorage.getItem('musicTime') || '0');
            if (savedTime > 0 && Math.abs(ambientMusic.currentTime - savedTime) > 2) {
              ambientMusic.currentTime = savedTime;
              console.log('â±ï¸ [after-swap] æ¢å¤æ’­æ”¾ä½ç½®åˆ°:', savedTime);
            }
            ambientMusic.play().then(() => {
              console.log('âœ… [after-swap] éŸ³ä¹å·²æˆåŠŸæ¢å¤æ’­æ”¾');
              window.__pendingMusicResume = false;
            }).catch(err => {
              console.error('âŒ [after-swap] æ¢å¤æ’­æ”¾å¤±è´¥ï¼ˆå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’ï¼‰:', err);
              // æ ‡è®°éœ€è¦åœ¨ç”¨æˆ·äº¤äº’æ—¶æ¢å¤
              window.__pendingMusicResume = true;
            });
          } else if (!shouldBePlaying && !ambientMusic.paused) {
            console.log('ğŸ”§ [after-swap] æ£€æµ‹åˆ°éŸ³ä¹åº”è¯¥æš‚åœä½†æ­£åœ¨æ’­æ”¾ï¼Œæ­£åœ¨æš‚åœ...');
            ambientMusic.pause();
          } else {
            console.log('âœ… [after-swap] éŸ³ä¹çŠ¶æ€ä¸ localStorage ä¸€è‡´ï¼Œæ— éœ€è°ƒæ•´');
          }
        }
      });

      // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
      window.addEventListener('beforeunload', () => {
        const ambientMusic = window.__globalAudio;
        if (ambientMusic && !ambientMusic.paused) {
          console.log('ğŸ’¾ é¡µé¢å¸è½½ï¼Œä¿å­˜éŸ³ä¹çŠ¶æ€');
          localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
          localStorage.setItem('musicPlaying', 'true');
        }
      });

      // é¡µé¢éšè—æ—¶ä¿å­˜çŠ¶æ€
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          const ambientMusic = window.__globalAudio;
          if (ambientMusic && !ambientMusic.paused) {
            console.log('ğŸ‘ï¸ é¡µé¢éšè—ï¼Œä¿å­˜éŸ³ä¹çŠ¶æ€');
            localStorage.setItem('musicTime', ambientMusic.currentTime.toString());
            localStorage.setItem('musicPlaying', 'true');
          }
        }
      });
    </script>
  </body>
</html>
