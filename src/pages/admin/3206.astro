---
import BaseLayout from '../../layouts/BaseLayout.astro';
import '../../styles/global.css';
---

<BaseLayout title="Track Admin">
  <main class="track-admin page-container">
    <a href="/" class="back-link">← Back to Map</a>

    <h1 class="page-title">Track Admin</h1>
    <p class="page-subtitle">简历访问监控</p>

    <div class="filter-bar">
      <label>
        从
        <input type="datetime-local" id="fromTime" />
      </label>
      <label>
        到
        <input type="datetime-local" id="toTime" />
      </label>
      <label>
        关键词
        <input type="text" id="keyword" placeholder="ip/path/ua/ref/session_id" />
      </label>
      <label>
        行数
        <input type="number" id="limit" value="200" min="100" max="10000" step="100" />
      </label>
      <button id="refreshBtn">刷新</button>
    </div>

    <div class="toggle-row">
      <div class="type-toggle" id="typeToggle">
        <span class="toggle-label">类型</span>
        <button type="button" class="type-btn active" data-type="human">Human</button>
        <button type="button" class="type-btn" data-type="bot">Bot</button>
        <button type="button" class="type-btn" data-type="all">All</button>
      </div>
      <div class="type-toggle" id="behaviorToggle">
        <span class="toggle-label">行为</span>
        <button type="button" class="type-btn active" data-behavior="human">Human行为</button>
        <button type="button" class="type-btn" data-behavior="all">全部</button>
      </div>
    </div>

    <section class="stats-panel">
      <div class="stat-item">
        <div class="stat-label">24h PV</div>
        <div class="stat-value" id="pv24h">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">24h UV</div>
        <div class="stat-value" id="uv24h">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">1h IP</div>
        <div class="stat-value" id="ip1h">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">平均停留(24h)</div>
        <div class="stat-value" id="avgDuration">-</div>
      </div>
    </section>

    <section class="top-paths">
      <h2>Top Paths (24h)</h2>
      <div id="topPaths"></div>
    </section>

    <section class="log-table">
      <table>
        <thead>
          <tr>
            <th>时间</th>
            <th>标签</th>
            <th>事件</th>
            <th>路径</th>
            <th>IP</th>
            <th>Session</th>
            <th>停留(s)</th>
            <th>Ref</th>
            <th class="ua-col">UA</th>
          </tr>
        </thead>
        <tbody id="logList"></tbody>
      </table>
    </section>

    <div class="ua-modal" id="uaModal">
      <div class="ua-modal-content">
        <button type="button" class="ua-modal-close" id="uaModalClose">×</button>
        <div class="ua-modal-section">
          <div class="ua-modal-title">UA</div>
          <div class="ua-modal-text" id="uaModalUa"></div>
        </div>
        <div class="ua-modal-section">
          <div class="ua-modal-title">时间</div>
          <div class="ua-modal-text" id="uaModalTs"></div>
        </div>
        <div class="ua-modal-section">
          <div class="ua-modal-title">Ref</div>
          <div class="ua-modal-text" id="uaModalRef"></div>
        </div>
        <div class="ua-modal-section">
          <div class="ua-modal-title">路径</div>
          <div class="ua-modal-text" id="uaModalPath"></div>
        </div>
        <div class="ua-modal-section">
          <div class="ua-modal-title">事件</div>
          <div class="ua-modal-text" id="uaModalEvent"></div>
        </div>
        <div class="ua-modal-section">
          <div class="ua-modal-title">Session</div>
          <div class="ua-modal-text" id="uaModalSession"></div>
        </div>
        <div class="ua-modal-section">
          <div class="ua-modal-title">IP</div>
          <div class="ua-modal-text" id="uaModalIp"></div>
        </div>
        <div class="ua-modal-section">
          <div class="ua-modal-title">Agent</div>
          <div class="ua-modal-text" id="uaModalAgent"></div>
        </div>
        <div class="ua-modal-section">
          <div class="ua-modal-title">Human行为</div>
          <div class="ua-modal-text" id="uaModalBehavior"></div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<style>
  .track-admin {
    max-width: 1200px;
    padding-top: 4.5rem;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
    align-items: flex-end;
    justify-content: center;
  }

  .filter-bar label {
    display: flex;
    flex-direction: column;
    font-family: var(--font-sans);
    font-size: 0.875rem;
    color: var(--ink-soft);
    gap: 0.5rem;
  }

  .filter-bar input {
    padding: 0.5rem 0.75rem;
    border: 1px solid rgba(74, 74, 74, 0.3);
    background: rgba(255, 255, 255, 0.6);
    font-family: var(--font-sans);
    font-size: 0.875rem;
  }

  #refreshBtn {
    padding: 0.55rem 1rem;
    border: 1px solid var(--ink-main);
    background: transparent;
    cursor: pointer;
    font-family: var(--font-sans);
    font-size: 0.875rem;
    color: var(--ink-main);
  }

  .toggle-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .type-toggle {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .toggle-label {
    font-size: 0.75rem;
    color: var(--ink-soft);
  }

  .type-btn {
    padding: 0.35rem 0.75rem;
    border: 1px solid rgba(74, 74, 74, 0.3);
    background: transparent;
    cursor: pointer;
    font-family: var(--font-sans);
    font-size: 0.8125rem;
    color: var(--ink-soft);
  }

  .type-btn.active {
    border-color: var(--ink-main);
    color: var(--ink-main);
    background: rgba(255, 255, 255, 0.4);
  }

  .stats-panel {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
    width: 100%;
  }

  .stat-item {
    border: 1px solid rgba(74, 74, 74, 0.2);
    padding: 1rem;
    background: rgba(255, 255, 255, 0.4);
  }

  .stat-label {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: var(--ink-soft);
    margin-bottom: 0.5rem;
  }

  .stat-value {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    color: var(--ink-main);
  }

  .top-paths {
    margin-bottom: 2rem;
    width: 100%;
  }

  .top-paths h2 {
    font-family: var(--font-serif);
    font-size: 1.25rem;
    margin-bottom: 1rem;
  }

  #topPaths {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .top-path-row {
    display: flex;
    justify-content: space-between;
    border-bottom: 1px dashed rgba(74, 74, 74, 0.2);
    padding-bottom: 0.4rem;
  }

  .log-table table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: var(--ink-main);
  }

  .log-table th,
  .log-table td {
    border: 1px solid rgba(74, 74, 74, 0.2);
    padding: 0.5rem 0.75rem;
    vertical-align: top;
    text-align: left;
    background: rgba(255, 255, 255, 0.35);
  }

  .log-table th {
    background: rgba(255, 255, 255, 0.6);
    font-weight: 600;
  }

  .bot-tag {
    display: inline-block;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.08);
    color: rgba(0, 0, 0, 0.6);
    font-size: 0.7rem;
  }

  .human-tag {
    display: inline-block;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
    background: rgba(74, 74, 74, 0.12);
    color: rgba(74, 74, 74, 0.8);
    font-size: 0.7rem;
  }

  .ua-col {
    width: 180px;
  }

  .ua-short {
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .ua-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }

  .ua-modal.active {
    display: flex;
  }

  .ua-modal-content {
    position: relative;
    width: min(720px, 92vw);
    background: var(--bg-parchment);
    border: 1px solid rgba(74, 74, 74, 0.2);
    padding: 1.5rem;
    text-align: left;
  }

  .ua-modal-close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    border: none;
    background: transparent;
    font-size: 1.25rem;
    cursor: pointer;
    color: var(--ink-soft);
  }

  .ua-modal-section {
    margin-bottom: 1rem;
  }

  .ua-modal-title {
    font-size: 0.75rem;
    color: var(--ink-soft);
    margin-bottom: 0.35rem;
  }

  .ua-modal-text {
    font-family: var(--font-sans);
    font-size: 0.875rem;
    color: var(--ink-main);
    word-break: break-word;
  }

  .log-empty {
    text-align: center;
    color: var(--ink-soft);
  }

  @media (max-width: 768px) {
    .stats-panel {
      grid-template-columns: 1fr;
    }
  }
</style>

<script is:inline>
  const logList = document.getElementById('logList');
  const refreshBtn = document.getElementById('refreshBtn');
  const fromTime = document.getElementById('fromTime');
  const toTime = document.getElementById('toTime');
  const keyword = document.getElementById('keyword');
  const limitInput = document.getElementById('limit');
  const pv24h = document.getElementById('pv24h');
  const uv24h = document.getElementById('uv24h');
  const ip1h = document.getElementById('ip1h');
  const avgDuration = document.getElementById('avgDuration');
  const topPaths = document.getElementById('topPaths');
  const typeToggle = document.getElementById('typeToggle');
  const behaviorToggle = document.getElementById('behaviorToggle');
  const uaModal = document.getElementById('uaModal');
  const uaModalClose = document.getElementById('uaModalClose');
  const uaModalUa = document.getElementById('uaModalUa');
  const uaModalTs = document.getElementById('uaModalTs');
  const uaModalRef = document.getElementById('uaModalRef');
  const uaModalPath = document.getElementById('uaModalPath');
  const uaModalEvent = document.getElementById('uaModalEvent');
  const uaModalSession = document.getElementById('uaModalSession');
  const uaModalIp = document.getElementById('uaModalIp');
  const uaModalAgent = document.getElementById('uaModalAgent');
  const uaModalBehavior = document.getElementById('uaModalBehavior');

  let currentType = 'human';
  let currentBehavior = 'human';

  function formatTime(ts) {
    const date = new Date(ts);
    return Number.isNaN(date.getTime()) ? '-' : date.toLocaleString();
  }

  function buildQuery() {
    const params = new URLSearchParams();
    if (fromTime.value) params.set('from', new Date(fromTime.value).toISOString());
    if (toTime.value) params.set('to', new Date(toTime.value).toISOString());
    if (keyword.value) params.set('q', keyword.value.trim());
    if (limitInput.value) params.set('limit', limitInput.value);
    if (currentType) params.set('type', currentType);
    if (currentBehavior) params.set('behavior', currentBehavior);
    return params.toString();
  }

  function renderTopPaths(list) {
    topPaths.innerHTML = '';
    if (!list || list.length === 0) {
      topPaths.textContent = '暂无数据';
      return;
    }
    list.forEach(item => {
      const row = document.createElement('div');
      row.className = 'top-path-row';
      row.innerHTML = `<span>${item.path || '-'}</span><span>${item.count}</span>`;
      topPaths.appendChild(row);
    });
  }

  function renderLogs(items) {
    logList.innerHTML = '';
    if (!items || items.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `<td class="log-empty" colspan="8">当前条件无数据</td>`;
      logList.appendChild(row);
      return;
    }
    items.forEach(item => {
      const agentType = item.agent_type || 'unknown';
      const botTag = item.bot_tag ? `BOT(${item.bot_tag})` : 'BOT';
      let labelHtml = '';
      if (agentType === 'bot') {
        labelHtml = `<span class="bot-tag">${botTag}</span>`;
      } else if (item.is_human_action) {
        labelHtml = `<span class="human-tag">HUMAN</span>`;
      } else if (agentType === 'unknown') {
        labelHtml = `<span class="bot-tag">UNK</span>`;
      }
      const durationKey = `${item.session_id || ''}__${item.path || ''}`;
      const durationMs = Number((window.__sessionDurations || {})[durationKey] || 0);
      const durationSec = Math.round(durationMs / 1000);
      const uaShort = item.ua_short || '-';
      const uaFull = item.ua_full || item.ua || '';
      const row = document.createElement('tr');
      row.className = 'log-row';
      row.dataset.rowId = item.row_id || '';
      row.dataset.ua = uaFull;
      row.dataset.ref = item.ref || '';
      row.dataset.session = item.session_id || '';
      row.dataset.ip = item.ip || '';
      row.dataset.event = item.event || '';
      row.dataset.path = item.path || '';
      row.dataset.ts = item.ts || '';
      row.dataset.agentType = agentType;
      row.dataset.botTag = item.bot_tag || '';
      row.dataset.isHumanAction = item.is_human_action ? 'true' : 'false';
      row.innerHTML = `
        <td>${formatTime(item.ts)}</td>
        <td>${labelHtml}</td>
        <td>${item.event || '-'}</td>
        <td>${item.path || '-'}</td>
        <td>${item.ip || '-'}</td>
        <td>${item.session_id || '-'}</td>
        <td>${durationSec}</td>
        <td>${item.ref || '-'}</td>
        <td><span class="ua-short">${uaShort}</span></td>
      `;
      logList.appendChild(row);
    });
  }

  async function loadLogs() {
    try {
      const query = buildQuery();
      const res = await fetch(`/api/track/admin?${query}`);
      const data = await res.json();
      if (!data.ok) throw new Error('load failed');
      pv24h.textContent = data.stats?.pv_24h ?? '-';
      uv24h.textContent = data.stats?.uv_24h ?? '-';
      ip1h.textContent = data.stats?.unique_ip_1h ?? '-';
      avgDuration.textContent = Math.round((data.stats?.avg_session_duration_ms || 0) / 1000);
      window.__sessionDurations = data.session_durations || {};
      renderTopPaths(data.stats?.top_paths_24h || []);
      renderLogs(data.items || []);
    } catch (err) {
      logList.innerHTML = '';
      const row = document.createElement('tr');
      row.innerHTML = `<td class="log-empty" colspan="8">当前条件无数据</td>`;
      logList.appendChild(row);
    }
  }

  function setDefaultRange() {
    const now = new Date();
    const from = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    const toValue = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
      .toISOString()
      .slice(0, 16);
    const fromValue = new Date(from.getTime() - from.getTimezoneOffset() * 60000)
      .toISOString()
      .slice(0, 16);
    if (!fromTime.value) fromTime.value = fromValue;
    if (!toTime.value) toTime.value = toValue;
    if (!keyword.value) keyword.value = '';
    currentType = 'human';
    currentBehavior = 'human';
    typeToggle.querySelectorAll('.type-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.type === currentType);
    });
    behaviorToggle.querySelectorAll('.type-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.behavior === currentBehavior);
    });
  }

  function openUaModal(payload) {
    uaModalUa.textContent = payload.ua || '-';
    uaModalTs.textContent = payload.ts || '-';
    uaModalRef.textContent = payload.ref || '-';
    uaModalPath.textContent = payload.path || '-';
    uaModalEvent.textContent = payload.event || '-';
    uaModalSession.textContent = payload.session || '-';
    uaModalIp.textContent = payload.ip || '-';
    const agentInfo = payload.agentType
      ? `${payload.agentType}${payload.botTag ? ` (${payload.botTag})` : ''}`
      : '-';
    uaModalAgent.textContent = agentInfo;
    uaModalBehavior.textContent = payload.isHumanAction === 'true' ? 'true' : 'false';
    uaModal.classList.add('active');
  }

  function closeUaModal() {
    uaModal.classList.remove('active');
  }

  logList.addEventListener('click', (event) => {
    const row = event.target.closest('.log-row');
    if (!row) return;
    openUaModal({
      ua: row.dataset.ua || '',
      ref: row.dataset.ref || '',
      session: row.dataset.session || '',
      ip: row.dataset.ip || '',
      event: row.dataset.event || '',
      path: row.dataset.path || '',
      ts: row.dataset.ts || '',
      agentType: row.dataset.agentType || '',
      botTag: row.dataset.botTag || '',
      isHumanAction: row.dataset.isHumanAction || 'false',
    });
  });

  uaModalClose.addEventListener('click', () => closeUaModal());
  uaModal.addEventListener('click', (event) => {
    if (event.target === uaModal) closeUaModal();
  });

  typeToggle.addEventListener('click', (event) => {
    const btn = event.target.closest('.type-btn');
    if (!btn) return;
    currentType = btn.dataset.type || 'human';
    typeToggle.querySelectorAll('.type-btn').forEach(item => {
      item.classList.toggle('active', item === btn);
    });
    loadLogs();
  });

  behaviorToggle.addEventListener('click', (event) => {
    const btn = event.target.closest('.type-btn');
    if (!btn) return;
    currentBehavior = btn.dataset.behavior || 'human';
    behaviorToggle.querySelectorAll('.type-btn').forEach(item => {
      item.classList.toggle('active', item === btn);
    });
    loadLogs();
  });

  refreshBtn.addEventListener('click', () => loadLogs());
  setDefaultRange();
  loadLogs();
</script>
