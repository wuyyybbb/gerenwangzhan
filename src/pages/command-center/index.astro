---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import '../../styles/global.css';

// 加载 Command Center 集合
const commandCenterPosts = await getCollection('command-center');

// 只显示已发布的内容，按 featured 和日期排序
const publishedPosts = commandCenterPosts
  .filter(post => post.data.status === 'published')
  .sort((a, b) => {
    // featured 文章优先
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    // 然后按日期降序排序
    return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
  });

// 统计各类型数量
const typeCounts = {
  all: publishedPosts.length,
  'decision-log': publishedPosts.filter(p => p.data.type === 'decision-log').length,
  'trade-offs': publishedPosts.filter(p => p.data.type === 'trade-offs').length,
  'system-thinking': publishedPosts.filter(p => p.data.type === 'system-thinking').length,
  'direction-notes': publishedPosts.filter(p => p.data.type === 'direction-notes').length,
};
---

<BaseLayout title="Command Center - Strategic Decisions">
  <main class="command-center-container">
    <!-- 返回按钮 -->
    <a href="/" class="back-link">
      ← Back to Map
    </a>

    <!-- 页面头部 -->
    <div class="page-header">
      <h1 class="page-title">Command Center</h1>
      <p class="page-subtitle">决策中枢</p>
      <p class="narrative-text">
        "Documenting how I make judgments, trade-offs, and take responsibility for outcomes under uncertainty."
      </p>
      <p class="narrative-text-zh">
        "记录我如何在不确定条件下做判断、做取舍并为后果负责。"
      </p>
    </div>

    <!-- 过滤器 -->
    <div class="filters-container">
      <button class="filter-tab active" data-filter="all">
        <span class="filter-label-en">All</span>
        <span class="filter-label-zh">全部</span>
      </button>
      <button class="filter-tab" data-filter="decision-log">
        <span class="filter-label-en">Decision Logs</span>
        <span class="filter-label-zh">决策日志</span>
      </button>
      <button class="filter-tab" data-filter="trade-offs">
        <span class="filter-label-en">Trade-offs</span>
        <span class="filter-label-zh">权衡分析</span>
      </button>
      <button class="filter-tab" data-filter="system-thinking">
        <span class="filter-label-en">System Thinking</span>
        <span class="filter-label-zh">系统思考</span>
      </button>
      <button class="filter-tab" data-filter="direction-notes">
        <span class="filter-label-en">Direction Notes</span>
        <span class="filter-label-zh">方向笔记</span>
      </button>
    </div>

    <!-- 内容统计 -->
    <div class="entry-count">
      <span class="count-number" id="entry-count">{publishedPosts.length}</span>
      <span class="count-label">entries</span>
    </div>

    <!-- 卡片网格 -->
    <div class="posts-grid" id="posts-grid">
      {publishedPosts.map((post) => {
        const year = new Date(post.data.date).getFullYear();
        const month = new Date(post.data.date).toLocaleDateString('en-US', { month: 'short' });

        return (
          <a
            href={`/command-center/${post.slug}`}
            class="post-card"
            data-type={post.data.type}
            class:list={{ 'featured': post.data.featured }}
          >
            <div class="card-header">
              <span class="card-type">{post.data.type}</span>
              <span class="card-date">{month} {year}</span>
            </div>

            {post.data.featured && (
              <div class="featured-badge">
                <span class="badge-en">Featured</span>
                <span class="badge-zh">置顶</span>
              </div>
            )}

            <h3 class="card-title-en">{post.data.title_en}</h3>
            <p class="card-title-zh">{post.data.title_zh}</p>

            {post.data.summary && (
              <p class="card-summary">{post.data.summary}</p>
            )}

            <div class="card-footer">
              {post.data.tags.length > 0 && (
                <div class="card-tags">
                  {post.data.tags.slice(0, 3).map(tag => (
                    <span class="tag-chip">{tag}</span>
                  ))}
                </div>
              )}
            </div>
          </a>
        );
      })}
    </div>

    <!-- 空状态 -->
    <div class="empty-state" id="empty-state" style="display: none;">
      <p class="empty-message">No entries found for this filter.</p>
      <p class="empty-message-zh">该分类暂无内容。</p>
    </div>
  </main>
</BaseLayout>

<script define:vars={{ typeCounts }}>
  // 客户端过滤逻辑
  function filterPosts() {
    const filterTabs = document.querySelectorAll('.filter-tab');
    const postCards = document.querySelectorAll('.post-card');
    const entryCount = document.getElementById('entry-count');
    const emptyState = document.getElementById('empty-state');

    let activeFilter = 'all';

    filterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // 更新选中状态
        filterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        activeFilter = tab.getAttribute('data-filter');

        // 过滤卡片
        let visibleCount = 0;
        postCards.forEach(card => {
          const cardType = card.getAttribute('data-type');
          if (activeFilter === 'all' || cardType === activeFilter) {
            card.style.display = 'flex';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        // 更新计数
        if (entryCount) {
          entryCount.textContent = typeCounts[activeFilter] || visibleCount;
        }

        // 显示/隐藏空状态
        if (emptyState) {
          emptyState.style.display = visibleCount === 0 ? 'block' : 'none';
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', filterPosts);
</script>

<style>
  .command-center-container {
    min-height: 100vh;
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
  }

  .back-link {
    display: inline-block;
    font-family: var(--font-sans);
    font-size: 0.875rem;
    color: var(--ink-soft);
    margin-bottom: 3rem;
    transition: color 0.3s ease;
  }

  .back-link:hover {
    color: var(--ink-main);
  }

  .page-header {
    margin-bottom: 4rem;
  }

  .page-title {
    font-family: var(--font-serif);
    font-size: 3rem;
    color: var(--ink-main);
    margin-bottom: 0.5rem;
    line-height: 1.2;
  }

  .page-subtitle {
    font-family: var(--font-zh-display);
    font-size: 3.5rem;
    color: var(--ink-soft);
    opacity: 0.7;
    letter-spacing: 0.05em;
    margin-bottom: 2rem;
  }

  .narrative-text {
    font-family: var(--font-sans);
    font-size: 1.125rem;
    color: var(--ink-soft);
    font-style: italic;
    line-height: 1.6;
    margin-bottom: 0.5rem;
  }

  .narrative-text-zh {
    font-family: var(--font-zh-display);
    font-size: 2rem;
    color: var(--ink-soft);
    opacity: 0.7;
    letter-spacing: 0.05em;
  }

  /* 过滤器 */
  .filters-container {
    display: flex;
    gap: 1.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid rgba(74, 74, 74, 0.2);
    margin-bottom: 3rem;
    flex-wrap: wrap;
  }

  .filter-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.75rem 1.5rem;
    border: 2px solid transparent;
    background: none;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .filter-tab:hover {
    border-color: var(--ink-soft);
  }

  .filter-tab.active {
    border: 2px solid var(--ink-main);
    background-color: rgba(31, 31, 31, 0.05);
  }

  .filter-label-en {
    font-family: var(--font-sans);
    font-size: 0.875rem;
    color: var(--ink-main);
    letter-spacing: 0.05em;
  }

  .filter-label-zh {
    font-family: var(--font-zh-display);
    font-size: 1.75rem;
    color: var(--ink-soft);
    opacity: 0.7;
    letter-spacing: 0.05em;
  }

  .filter-tab.active .filter-label-en {
    font-weight: 600;
  }

  .filter-tab.active .filter-label-zh {
    opacity: 1;
  }

  /* 计数 */
  .entry-count {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }

  .count-number {
    font-family: var(--font-serif);
    font-size: 2rem;
    color: var(--ink-main);
  }

  .count-label {
    font-family: monospace;
    font-size: 0.875rem;
    color: var(--ink-soft);
    letter-spacing: 0.1em;
  }

  /* 卡片网格 */
  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 4rem;
  }

  .post-card {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 2rem;
    border: 1px solid var(--ink-soft);
    transition: border-color 0.3s ease, transform 0.3s ease;
    cursor: pointer;
    min-height: 280px;
    height: 100%;
    position: relative;
  }

  .post-card.featured {
    border: 2px solid var(--ink-main);
    background-color: rgba(31, 31, 31, 0.02);
  }

  .post-card:hover {
    border-color: var(--ink-main);
    transform: translateY(-2px);
  }

  .featured-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.15rem;
    padding: 0.4rem 0.75rem;
    background-color: var(--ink-main);
    color: var(--paper-main);
  }

  .badge-en {
    font-family: var(--font-sans);
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .badge-zh {
    font-family: var(--font-zh-display);
    font-size: 1rem;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: monospace;
    font-size: 0.75rem;
    color: var(--ink-soft);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .card-type {
    color: var(--ink-main);
  }

  .card-title-en {
    font-family: var(--font-serif);
    font-size: 1.5rem;
    color: var(--ink-main);
    line-height: 1.3;
    letter-spacing: 0.02em;
    margin-top: 0.5rem;
  }

  .card-title-zh {
    font-family: var(--font-zh-display);
    font-size: 2rem;
    color: var(--ink-soft);
    opacity: 0.8;
    letter-spacing: 0.05em;
    margin: 0;
  }

  .card-summary {
    font-family: var(--font-sans);
    font-size: 0.9375rem;
    color: var(--ink-soft);
    line-height: 1.6;
    flex-grow: 1;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
    padding-top: 1rem;
    border-top: 1px solid rgba(74, 74, 74, 0.1);
  }

  .card-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag-chip {
    font-family: var(--font-sans);
    font-size: 0.7rem;
    color: var(--ink-soft);
    padding: 0.2rem 0.5rem;
    border: 1px solid var(--ink-soft);
    letter-spacing: 0.05em;
  }

  /* 空状态 */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-message {
    font-family: var(--font-sans);
    font-size: 1rem;
    color: var(--ink-soft);
    margin-bottom: 0.5rem;
  }

  .empty-message-zh {
    font-family: var(--font-zh-display);
    font-size: 2rem;
    color: var(--ink-soft);
    opacity: 0.7;
  }

  @media (max-width: 768px) {
    .command-center-container {
      padding: 1.5rem;
    }

    .page-title {
      font-size: 2rem;
    }

    .page-subtitle {
      font-size: 2.5rem;
    }

    .narrative-text {
      font-size: 1rem;
    }

    .narrative-text-zh {
      font-size: 1.75rem;
    }

    .posts-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .filter-label-zh {
      font-size: 1.5rem;
    }
  }
</style>
