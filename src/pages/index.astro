---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/global.css';

// è®¾è®¡ç”»å¸ƒå¸¸é‡
const DESIGN_W = 1920;
const DESIGN_H = 1072;

// ç»“æ„åŒ–æ•°æ®ï¼ˆSchema.org / JSON-LDï¼‰ç”¨äº SEO
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    // 1. Person - ä¸ªäººä¿¡æ¯
    {
      "@type": "Person",
      "@id": "https://wuyebei.cn/#person",
      "name": "å´å¶è´",
      "alternateName": "Wu Yebei",
      "url": "https://wuyebei.cn",
      "image": "https://wuyebei.cn/og-image.jpg",
      "description": "ä¸“æ³¨äº AI åº”ç”¨ã€çŸ¥è¯†ä½“ç³»ä¸æ™ºèƒ½å·¥ä½œæµçš„å®è·µè€…ã€‚Builder â†’ Intelligent Pioneerã€‚æ„å»ºæ™ºèƒ½ç³»ç»Ÿï¼Œå»¶å±•äººçš„èƒ½åŠ¨æ€§ï¼Œè€Œéå–ä»£ã€‚",
      "jobTitle": "AI äº§å“æ„å»ºè€… / æ™ºèƒ½å·¥ä½œæµè®¾è®¡å¸ˆ",
      "sameAs": [
        "https://space.bilibili.com/YOUR_UID",
        "https://github.com/YOUR_USERNAME",
        "https://www.xiaohongshu.com/user/profile/YOUR_ID"
      ],
      "knowsAbout": [
        "Artificial Intelligence",
        "AI Workflows",
        "Generative AI",
        "ComfyUI",
        "Stable Diffusion",
        "AI Product Design",
        "Knowledge Systems",
        "Intelligent Automation",
        "System Thinking",
        "Decision Making Frameworks",
        "AI Image Generation",
        "Product Strategy",
        "Technical Architecture"
      ],
      "hasOccupation": {
        "@type": "Occupation",
        "name": "AI äº§å“æ„å»ºè€…",
        "occupationLocation": {
          "@type": "Country",
          "name": "ä¸­å›½"
        },
        "skills": [
          "AI å·¥ä½œæµè®¾è®¡",
          "ComfyUI å¼€å‘",
          "ç”Ÿæˆå¼ AI åº”ç”¨",
          "äº§å“è®¾è®¡",
          "ç³»ç»Ÿæ¶æ„",
          "çŸ¥è¯†ç®¡ç†"
        ]
      }
    },
    // 2. WebSite - ç½‘ç«™ä¿¡æ¯
    {
      "@type": "WebSite",
      "@id": "https://wuyebei.cn/#website",
      "url": "https://wuyebei.cn",
      "name": "å´å¶è´çš„ä¸ªäººç½‘ç«™ | Wu Yebei's Personal Site",
      "description": "æ¢ç´¢ AI å·¥ä½œæµã€ç”Ÿæˆå¼è®¾è®¡ä¸æ™ºèƒ½ç³»ç»Ÿçš„å®è·µç©ºé—´ã€‚Knowledge Towerã€AI Workshopã€Command Center ä¸ Ancient Archivesã€‚",
      "inLanguage": ["zh-CN", "en-US"],
      "publisher": {
        "@id": "https://wuyebei.cn/#person"
      },
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://wuyebei.cn/log?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    },
    // 3. WebPage - é¦–é¡µä¿¡æ¯
    {
      "@type": "WebPage",
      "@id": "https://wuyebei.cn/#webpage",
      "url": "https://wuyebei.cn",
      "name": "å´å¶è´ | Wu Yebei - Intelligent Pioneer",
      "description": "From Builder to Intelligent Pioneer. æ„å»ºæ™ºèƒ½ç³»ç»Ÿï¼Œå»¶å±•äººçš„èƒ½åŠ¨æ€§ã€‚æ¢ç´¢ AI å·¥ä½œæµã€ComfyUIã€ç”Ÿæˆå¼è®¾è®¡ã€äº§å“æ€è€ƒä¸å†³ç­–æ¡†æ¶ã€‚",
      "isPartOf": {
        "@id": "https://wuyebei.cn/#website"
      },
      "about": {
        "@id": "https://wuyebei.cn/#person"
      },
      "primaryImageOfPage": {
        "@type": "ImageObject",
        "url": "https://wuyebei.cn/og-image.jpg",
        "width": 1200,
        "height": 630
      },
      "inLanguage": "zh-CN"
    },
    // 4. CollectionPage - Knowledge Towerï¼ˆçŸ¥è¯†å¡”ï¼‰
    {
      "@type": "CollectionPage",
      "@id": "https://wuyebei.cn/log#collection",
      "url": "https://wuyebei.cn/log",
      "name": "Knowledge Tower - çŸ¥è¯†å¡”",
      "description": "AI è¯¾ç¨‹ã€ç ”ç©¶è®ºæ–‡ã€æŠ€æœ¯æ€è€ƒä¸å®è·µç¬”è®°çš„é›†åˆã€‚ComfyUI æ•™ç¨‹ã€ç”Ÿæˆå¼ AI åº”ç”¨ã€äº§å“è®¾è®¡æ€è€ƒã€‚",
      "isPartOf": {
        "@id": "https://wuyebei.cn/#website"
      },
      "hasPart": [
        {
          "@type": "Course",
          "name": "ComfyUI å®Œæ•´è¯¾ç¨‹",
          "description": "ä»é›¶æ­å»ºå¯å¤ç”¨çš„ AI å›¾åƒç”Ÿæˆå·¥ä½œæµï¼Œæ¶µç›– ComfyUI åŸºç¡€ã€ControlNetã€IP-Adapterã€å…‰å½±æ§åˆ¶ç­‰é«˜çº§æŠ€æœ¯",
          "provider": {
            "@id": "https://wuyebei.cn/#person"
          },
          "inLanguage": "zh-CN",
          "coursePrerequisites": "AI å›¾åƒç”ŸæˆåŸºç¡€",
          "educationalLevel": "Intermediate to Advanced"
        }
      ]
    },
    // 5. BlogPosting - Command Centerï¼ˆæŒ‡æŒ¥ä¸­å¿ƒï¼‰
    {
      "@type": "Blog",
      "@id": "https://wuyebei.cn/command#blog",
      "url": "https://wuyebei.cn/command",
      "name": "Command Center - æŒ‡æŒ¥ä¸­å¿ƒ",
      "description": "æˆ˜ç•¥å†³ç­–ã€æƒè¡¡åˆ†æä¸æ¶æ„æ€è€ƒã€‚Decision Logsã€Trade-offsã€System Thinkingã€Direction Notesã€‚",
      "isPartOf": {
        "@id": "https://wuyebei.cn/#website"
      },
      "author": {
        "@id": "https://wuyebei.cn/#person"
      },
      "inLanguage": "zh-CN"
    },
    // 6. BreadcrumbList - é¢åŒ…å±‘å¯¼èˆª
    {
      "@type": "BreadcrumbList",
      "@id": "https://wuyebei.cn/#breadcrumb",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "é¦–é¡µ",
          "item": "https://wuyebei.cn"
        }
      ]
    }
  ]
};

// Debug æ¨¡å¼ï¼ˆå¼€å‘æ—¶è®¾ä¸º trueï¼Œæˆ–æŒ‰ D é”®åˆ‡æ¢ï¼‰
const DEBUG_MODE = false;

// æ ¸å¿ƒå»ºç­‘ï¼ˆä¸­å¿ƒç‚¹ï¼‰
const coreBuilding = {
  building: {
    basePath: '/map/core_building', // ä¸å¸¦æ‰©å±•å
    rect: { x: 580, y: 280, w: 200, h: 300 },
    transform: { scale: 1.8, dx: 0, dy: 0 },
  },
  center: { x: 938, y: 395 }, // å…‰æŸèµ·ç‚¹ï¼ˆé—¨å£ä½ç½®ï¼‰
};

// åœ°æ ‡é…ç½®ï¼ˆå•ä¸€æ•°æ®æºï¼‰
// Sign ä½ç½®ï¼šç´§è´´å»ºç­‘åº•è¾¹ï¼ŒsignY = buildingBottomY
const landmarks = [
  {
    id: 'workshop',
    route: '/workshop',
    title_en: 'AI Workshop',
    title_zh: 'AI å®éªŒåŠ',
    building: {
      basePath: '/map/workshop_building',
      rect: { x: -50, y: 480, w: 120, h: 280 },
      transform: { scale: 4.1, dx: 0, dy: -140 },
      hoverScale: 4.5, // æ‚¬åœæ—¶çš„ç¼©æ”¾å€æ•°
    },
    sign: {
      basePath: '/map/workshop_sign',
      rect: { x: -55, y: 280, w: 140, h: 60 },
      transform: { scale: 2.1, dx: 0, dy: 0 },
      hoverScale: 1.04, // æ‚¬åœæ—¶çš„ç¼©æ”¾å€æ•°
    },
    clickableRect: { x: -30, y: 150, w: 240, h: 320 },
    beamEnd: { x: -30, y: 250 }, // å»ºç­‘ä¸­å¿ƒç‚¹
  },
  {
    id: 'knowledge',
    route: '/log',
    title_en: 'Knowledge Tower',
    title_zh: 'çŸ¥è¯†å¡”',
    building: {
      basePath: '/map/knowledge_building',
      rect: { x: 1200, y: 85, w: 300, h: 420 },
      transform: { scale: 1.75, dx: 0, dy: -90 },
      hoverScale: 1.05, // æ‚¬åœæ—¶çš„ç¼©æ”¾å€æ•°
    },
    sign: {
      basePath: '/map/knowledge_sign',
      rect: { x: 1300, y: 230, w: 140, h: 60 },
      transform: { scale: 2.1, dx: 0, dy: 0 },
      hoverScale: 1.04, // æ‚¬åœæ—¶çš„ç¼©æ”¾å€æ•°
    },
    clickableRect: { x: 1100, y: -100, w: 300, h: 480 },
    beamEnd: { x: 1800, y: 100 }, // å»ºç­‘ä¸­å¿ƒç‚¹
  },
  {
    id: 'archives',
    route: '/archives',
    title_en: 'Ancient Archives',
    title_zh: 'å¤å·åº“',
    building: {
      basePath: '/map/archives_building',
      rect: { x: -80, y: 500, w: 320, h: 300 },
      transform: { scale: 1.7, dx: 0, dy: 0 },
      hoverScale: 1.05, // æ‚¬åœæ—¶çš„ç¼©æ”¾å€æ•°
    },
    sign: {
      basePath: '/map/archives_sign',
      rect: { x: 80, y: 640, w: 200, h: 60 },
      transform: { scale: 1.65, dx: 0, dy: 0 },
      hoverScale: 1.04, // æ‚¬åœæ—¶çš„ç¼©æ”¾å€æ•°
    },
    clickableRect: { x: 80, y: 300, w: 320, h: 330 },
    beamEnd: { x: 80, y: 780 }, // å»ºç­‘ä¸­å¿ƒç‚¹
  },
  {
    id: 'command',
    route: '/command',
    title_en: 'Command Center',
    title_zh: 'æŒ‡æŒ¥æ‰€',
    building: {
      basePath: '/map/command_building',
      rect: { x: 1050, y: 330, w: 360, h: 320 },
      transform: { scale: 1.1, dx: 0, dy: 0 },
      hoverScale: 1.05, // æ‚¬åœæ—¶çš„ç¼©æ”¾å€æ•°
    },
    sign: {
      basePath: '/map/command_sign',
      rect: { x: 1150, y: 600, w: 200, h: 60 },
      transform: { scale: 1.6, dx: 0, dy: 0 },
      hoverScale: 1.04, // æ‚¬åœæ—¶çš„ç¼©æ”¾å€æ•°
    },
    clickableRect: { x: 980, y: 450, w: 360, h: 340 },
    beamEnd: { x: 1700, y: 650 }, // å»ºç­‘ä¸­å¿ƒç‚¹
  },
];
---

<BaseLayout
  title="Mythic Engraving Interactive Map"
  structuredData={structuredData}
>
  <div class="map-wrapper">
    <!-- ğŸ¯ Placeholder å±‚ï¼šçº¯è‰²èƒŒæ™¯ï¼Œé¿å… FOUC -->
    <div class="map-placeholder"></div>

    <!-- ğŸ¯ èƒŒæ™¯å›¾å±‚ï¼šçº¯ CSS é“ºæ»¡ï¼Œä¸ä¾èµ– JS -->
    <img
      id="mapBackground"
      class="map-background"
      src="/map/background.webp"
      alt="Interactive Map Background"
      loading="eager"
      fetchpriority="high"
      decoding="async"
      data-lcp-target
      onerror="console.error('âŒ LCP èƒŒæ™¯å›¾åŠ è½½å¤±è´¥');"
    />

    <!-- å›ºå®šç”»å¸ƒå®¹å™¨ï¼ˆäº¤äº’å±‚ï¼‰-->
    <div class="map-canvas" id="mapCanvas" data-design-w={DESIGN_W} data-design-h={DESIGN_H}>

      <!-- ä¸»æ ‡é¢˜ -->
      <div class="hero-title" style="left: 688px; top: -75px;">
        <div class="hero-subtitle">FROM BUILDER TO</div>
        <div class="hero-main">INTELLIGENT PIONEER</div>
      </div>

      <!-- å…‰æŸå±‚ï¼ˆå•ä¸€ inline SVG è¦†ç›–å±‚ï¼‰ -->
      <svg class="beam-layer" viewBox={`0 0 ${DESIGN_W} ${DESIGN_H}`} preserveAspectRatio="none">
        <defs>
          <!-- æ¨¡ç³Šæ»¤é•œï¼ˆå¢å¼ºæŸ”å’Œæ•ˆæœï¼‰ -->
          <filter id="blur20">
            <feGaussianBlur stdDeviation="20"/>
          </filter>
          <filter id="blur12">
            <feGaussianBlur stdDeviation="12"/>
          </filter>
          <filter id="blur6">
            <feGaussianBlur stdDeviation="6"/>
          </filter>

          <!-- ä¸­å¿ƒç‚¹æ¸å˜ -->
          <radialGradient id="coreGradient">
            <stop offset="0%" stop-color="#ffffff" />
            <stop offset="50%" stop-color="#ffe8a3" />
            <stop offset="100%" stop-color="#f6d37a" />
          </radialGradient>

          <!-- ä¸ºæ¯æ¡å…‰æŸç”Ÿæˆç‹¬ç«‹çš„æ¸å˜ -->
          {landmarks.map((landmark) => {
            const x1 = coreBuilding.center.x;
            const y1 = coreBuilding.center.y;
            const x2 = landmark.beamEnd.x;
            const y2 = landmark.beamEnd.y;
            const id = landmark.id;

            return (
              <>
                <!-- å†…å±‚æ¸å˜ï¼šç™½è‰²æµåŠ¨èŠ¯ -->
                <linearGradient id={`beamCore-${id}`} x1={x1} y1={y1} x2={x2} y2={y2} gradientUnits="userSpaceOnUse">
                  <stop offset="0%" stop-color="#ffffff" stop-opacity="0.9" />
                  <stop offset="50%" stop-color="#fffef5" stop-opacity="0.85" />
                  <stop offset="100%" stop-color="#ffffff" stop-opacity="0.8" />
                </linearGradient>

                <!-- ä¸­å±‚æ¸å˜ï¼šé‡‘é»„é›¾æ°” -->
                <linearGradient id={`beamWarm-${id}`} x1={x1} y1={y1} x2={x2} y2={y2} gradientUnits="userSpaceOnUse">
                  <stop offset="0%" stop-color="#f6d37a" stop-opacity="0.7" />
                  <stop offset="50%" stop-color="#f0c56a" stop-opacity="0.6" />
                  <stop offset="100%" stop-color="#f6d37a" stop-opacity="0.5" />
                </linearGradient>

                <!-- å¤–å±‚æ¸å˜ï¼šé‡‘é»„å…‰æ™• -->
                <linearGradient id={`beamGold-${id}`} x1={x1} y1={y1} x2={x2} y2={y2} gradientUnits="userSpaceOnUse">
                  <stop offset="0%" stop-color="#f6d37a" stop-opacity="0.5" />
                  <stop offset="50%" stop-color="#f1c85f" stop-opacity="0.4" />
                  <stop offset="100%" stop-color="#f6d37a" stop-opacity="0.3" />
                </linearGradient>
              </>
            );
          })}
        </defs>

        <!-- ä¸­å¿ƒå‘å…‰ç‚¹ï¼ˆå¯ç‚¹å‡»ï¼‰ -->
        <g id="coreBeacon">
          <circle
            cx={coreBuilding.center.x}
            cy={coreBuilding.center.y}
            r="12"
            fill="url(#coreGradient)"
            opacity="0.9"
            style="cursor: pointer;"
          >
            <animate attributeName="opacity" values="0.8;1;0.8" dur="2s" repeatCount="indefinite" />
            <animate attributeName="r" values="12;14;12" dur="2s" repeatCount="indefinite" />
          </circle>

          <!-- å¤–åœˆå…‰æ™• -->
          <circle
            cx={coreBuilding.center.x}
            cy={coreBuilding.center.y}
            r="20"
            fill="none"
            stroke="#ffe8a3"
            stroke-width="1"
            opacity="0.3"
          >
            <animate attributeName="r" values="20;28;20" dur="2.5s" repeatCount="indefinite" />
            <animate attributeName="opacity" values="0.3;0;0.3" dur="2.5s" repeatCount="indefinite" />
          </circle>
        </g>

        <!-- å…‰æŸç»„ï¼ˆä¸‰å±‚å åŠ  + æµåŠ¨é«˜å…‰ï¼‰ -->
        {landmarks.map((landmark, index) => {
          const x1 = coreBuilding.center.x;
          const y1 = coreBuilding.center.y;
          const x2 = landmark.beamEnd.x;
          const y2 = landmark.beamEnd.y;

          // è´å¡å°”æ›²çº¿æ§åˆ¶ç‚¹ï¼ˆæ‹±å½¢å‘ä¸Šï¼‰
          const controlX = (x1 + x2) / 2;
          const controlY = Math.min(y1, y2) - 120;
          const pathD = `M ${x1} ${y1} Q ${controlX} ${controlY} ${x2} ${y2}`;

          return (
            <g class="beam-group" data-beam-id={landmark.id}>
              <!-- å¤–å±‚ï¼šææ·¡é‡‘è‰²å…‰æ™•ï¼ˆæœ€å®½ï¼Œå¼ºæ¨¡ç³Šï¼‰ -->
              <path
                class="beam-path beam-outer"
                d={pathD}
                stroke={`url(#beamGold-${landmark.id})`}
                stroke-width="32"
                stroke-linecap="round"
                fill="none"
                filter="url(#blur20)"
                style="opacity: 0;"
              />

              <!-- ä¸­å±‚ï¼šæ·¡é‡‘é›¾æ°”ï¼ˆä¸­ç­‰å®½åº¦ï¼Œä¸­ç­‰æ¨¡ç³Šï¼‰ -->
              <path
                class="beam-path beam-mid"
                d={pathD}
                stroke={`url(#beamWarm-${landmark.id})`}
                stroke-width="16"
                stroke-linecap="round"
                fill="none"
                filter="url(#blur12)"
                style="opacity: 0;"
              />

              <!-- å†…å±‚ï¼šæ·¡ç™½èŠ¯ï¼ˆè¾ƒç»†ï¼Œè½»å¾®æ¨¡ç³Šï¼‰ -->
              <path
                class="beam-path beam-inner"
                d={pathD}
                stroke={`url(#beamCore-${landmark.id})`}
                stroke-width="6"
                stroke-linecap="round"
                fill="none"
                filter="url(#blur6)"
                style="opacity: 0;"
              />

              <!-- æµåŠ¨é«˜å…‰ï¼ˆç™½è‰²ç»†çº¿ï¼‰ -->
              <path
                class="beam-highlight"
                d={pathD}
                stroke="#ffffff"
                stroke-width="1.5"
                stroke-linecap="round"
                fill="none"
                style="opacity: 0;"
                stroke-dasharray="60 120"
                stroke-dashoffset="0"
              />

              <!-- æµåŠ¨ç²’å­æ•ˆæœï¼ˆç™½è‰²å…‰ç‚¹ï¼Œæå¿«æµåŠ¨ï¼‰ -->
              <circle class="beam-particle" r="2.5" fill="#ffffff" filter="url(#blur6)" style="opacity: 0;">
                <animateMotion dur="0.5s" repeatCount="indefinite" begin="0s">
                  <mpath href={`#beam-path-${landmark.id}`}/>
                </animateMotion>
              </circle>

              <circle class="beam-particle" r="2" fill="#ffffff" filter="url(#blur6)" style="opacity: 0;">
                <animateMotion dur="0.5s" repeatCount="indefinite" begin="0.15s">
                  <mpath href={`#beam-path-${landmark.id}`}/>
                </animateMotion>
              </circle>

              <circle class="beam-particle" r="1.5" fill="#fffef5" filter="url(#blur6)" style="opacity: 0;">
                <animateMotion dur="0.5s" repeatCount="indefinite" begin="0.3s">
                  <mpath href={`#beam-path-${landmark.id}`}/>
                </animateMotion>
              </circle>

              <!-- éšè—çš„è·¯å¾„ï¼Œä¾›ç²’å­åŠ¨ç”»ä½¿ç”¨ -->
              <path id={`beam-path-${landmark.id}`} d={pathD} fill="none" stroke="none" style="display: none;"/>
            </g>
          );
        })}
      </svg>

      <!-- æ ¸å¿ƒå»ºç­‘å±‚ï¼ˆå»¶è¿ŸåŠ è½½ï¼‰ -->
      <div
        class="building-container core-container lazy-image"
        data-building-id="core"
        data-lazy-src={coreBuilding.building.basePath}
        data-lazy-alt="Core Building"
        data-lazy-class="building-layer"
        style={`
          left: ${coreBuilding.building.rect.x}px;
          top: ${coreBuilding.building.rect.y}px;
          width: ${coreBuilding.building.rect.w}px;
          height: ${coreBuilding.building.rect.h}px;
          transform: translate(${coreBuilding.building.transform.dx}px, ${coreBuilding.building.transform.dy}px) scale(${coreBuilding.building.transform.scale});
        `}
      >
        <!-- img will be injected by IntersectionObserver -->
      </div>

      <!-- åœ°æ ‡å»ºç­‘å±‚ï¼ˆåªæœ‰ workshop ä¸º eager + LCP å€™é€‰ï¼Œå…¶ä½™ lazy + ä½ä¼˜å…ˆçº§ï¼‰ -->
      {landmarks.map(landmark => {
        const isWorkshop = landmark.id === 'workshop';

        if (isWorkshop) {
          return (
            <div
              class="building-container eager-image lcp-candidate"
              data-landmark-id={`${landmark.id}-building`}
              data-eager-src={landmark.building.basePath}
              data-eager-alt={`${landmark.title_en} Building`}
              data-eager-class="building-layer lcp-target"
              data-fetchpriority="high"
              style={`
                left: ${landmark.building.rect.x}px;
                top: ${landmark.building.rect.y}px;
                width: ${landmark.building.rect.w}px;
                height: ${landmark.building.rect.h}px;
                transform: translate(${landmark.building.transform.dx}px, ${landmark.building.transform.dy}px) scale(${landmark.building.transform.scale});
              `}
            >
              <!-- img will be injected immediately with fetchpriority="high" -->
            </div>
          );
        } else {
          return (
            <div
              class="building-container lazy-image"
              data-landmark-id={`${landmark.id}-building`}
              data-lazy-src={landmark.building.basePath}
              data-lazy-alt={`${landmark.title_en} Building`}
              data-lazy-class="building-layer"
              data-fetchpriority="low"
              style={`
                left: ${landmark.building.rect.x}px;
                top: ${landmark.building.rect.y}px;
                width: ${landmark.building.rect.w}px;
                height: ${landmark.building.rect.h}px;
                transform: translate(${landmark.building.transform.dx}px, ${landmark.building.transform.dy}px) scale(${landmark.building.transform.scale});
                content-visibility: auto;
              `}
            >
              <!-- img will be injected by IntersectionObserver with fetchpriority="low" -->
            </div>
          );
        }
      })}

      <!-- åœ°æ ‡æ ‡ç‰Œå±‚ï¼ˆæ‰€æœ‰ sign éƒ½ä½ä¼˜å…ˆçº§ï¼Œä¸å‚ä¸ LCP ç«äº‰ï¼‰ -->
      {landmarks.map(landmark => {
        const isWorkshop = landmark.id === 'workshop';

        if (isWorkshop) {
          return (
            <div
              class="sign-container eager-image"
              data-landmark-id={`${landmark.id}-sign`}
              data-eager-src={landmark.sign.basePath}
              data-eager-alt={`${landmark.title_en} Sign`}
              data-eager-class="sign-bg"
              data-fetchpriority="low"
              style={`
                left: ${landmark.sign.rect.x}px;
                top: ${landmark.sign.rect.y}px;
                width: ${landmark.sign.rect.w}px;
                height: ${landmark.sign.rect.h}px;
                transform: translate(${landmark.sign.transform.dx}px, ${landmark.sign.transform.dy}px) scale(${landmark.sign.transform.scale});
                content-visibility: auto;
              `}
            >
              <!-- img will be injected immediately with fetchpriority="low" -->
            </div>
          );
        } else {
          return (
            <div
              class="sign-container lazy-image"
              data-landmark-id={`${landmark.id}-sign`}
              data-lazy-src={landmark.sign.basePath}
              data-lazy-alt={`${landmark.title_en} Sign`}
              data-lazy-class="sign-bg"
              data-fetchpriority="low"
              style={`
                left: ${landmark.sign.rect.x}px;
                top: ${landmark.sign.rect.y}px;
                width: ${landmark.sign.rect.w}px;
                height: ${landmark.sign.rect.h}px;
                transform: translate(${landmark.sign.transform.dx}px, ${landmark.sign.transform.dy}px) scale(${landmark.sign.transform.scale});
                content-visibility: auto;
              `}
            >
              <!-- img will be injected by IntersectionObserver with fetchpriority="low" -->
            </div>
          );
        }
      })}

      <!-- Resume æ ‡è¯†ï¼ˆä¸­å¤®åº•éƒ¨ï¼‰- ğŸ”§ ä¼˜å…ˆåŠ è½½ï¼Œå…ˆäºç¤¾äº¤å›¾æ ‡ -->
      <a
        href="/resume"
        class="resume-badge eager-image"
        id="resumeBadge"
        data-eager-src="/map/resume.svg"
        data-eager-alt="Personal Resume Map"
        data-eager-class="resume-badge-img"
        data-fetchpriority="medium"
        data-astro-prefetch="false"
        style="
          left: 400px;
          top: 730px;
          width: 550px;
          height: 150px;
        "
        aria-label="View Resume"
      >
        <!-- picture will be injected immediately with medium priority -->
      </a>

      <!-- ç¤¾äº¤åª’ä½“å›¾æ ‡ï¼ˆResume Sign å†…éƒ¨ï¼‰- ğŸ”§ ä½ä¼˜å…ˆçº§ï¼Œæœ€ååŠ è½½ -->
      <div class="social-icons-container" style="
        left: 580px;
        top: 835px;
      ">
        <a
          href="https://space.bilibili.com/YOUR_UID"
          target="_blank"
          rel="noopener noreferrer"
          class="social-icon eager-image"
          data-eager-src="/map/bilibili.svg"
          data-eager-alt="Bilibili"
          data-eager-class="social-icon-img"
          data-fetchpriority="low"
          aria-label="Bilibili"
        >
          <!-- picture will be injected with low priority -->
        </a>

        <a
          href="https://github.com/YOUR_USERNAME"
          target="_blank"
          rel="noopener noreferrer"
          class="social-icon eager-image"
          data-eager-src="/map/github.svg"
          data-eager-alt="GitHub"
          data-eager-class="social-icon-img"
          data-fetchpriority="low"
          aria-label="GitHub"
        >
          <!-- picture will be injected with low priority -->
        </a>

        <a
          href="javascript:void(0)"
          class="social-icon eager-image"
          data-eager-src="/map/gongzhonghao.svg"
          data-eager-alt="WeChat Official Account"
          data-eager-class="social-icon-img"
          data-fetchpriority="low"
          aria-label="WeChat Official Account"
          data-popup="gongzhonghao"
        >
          <!-- picture will be injected with low priority -->
        </a>

        <a
          href="javascript:void(0)"
          class="social-icon eager-image"
          data-eager-src="/map/email.svg"
          data-eager-alt="Email"
          data-eager-class="social-icon-img"
          data-fetchpriority="low"
          aria-label="Email"
          data-popup="email"
        >
          <!-- picture will be injected with low priority -->
        </a>

        <a
          href="https://www.xiaohongshu.com/user/profile/YOUR_ID"
          target="_blank"
          rel="noopener noreferrer"
          class="social-icon eager-image"
          data-eager-src="/map/xiaohongshu.svg"
          data-eager-alt="Xiaohongshu"
          data-eager-class="social-icon-img"
          data-fetchpriority="low"
          aria-label="Xiaohongshu"
        >
          <!-- picture will be injected with low priority -->
        </a>

        <a
          href="javascript:void(0)"
          class="social-icon eager-image"
          data-eager-src="/map/wechat.svg"
          data-eager-alt="WeChat"
          data-eager-class="social-icon-img"
          data-fetchpriority="low"
          aria-label="WeChat"
          data-popup="wechat"
        >
          <!-- picture will be injected with low priority -->
        </a>
      </div>

      <!-- å¯ç‚¹å‡»çƒ­åŒºå±‚ -->
      <!-- æ ¸å¿ƒå»ºç­‘çƒ­åŒº -->
      <div
        class="landmark-hotspot-container core-hotspot-container"
        data-landmark-id="core-building"
        style={`
          left: ${coreBuilding.building.rect.x}px;
          top: ${coreBuilding.building.rect.y}px;
          width: ${coreBuilding.building.rect.w}px;
          height: ${coreBuilding.building.rect.h}px;
        `}
      >
        <a
          href="/about"
          class="landmark-hotspot core-hotspot"
          data-landmark="core-building"
          data-astro-prefetch="false"
          aria-label="About Me"
        >
          <span class="sr-only">About</span>
        </a>
      </div>

      {landmarks.map(landmark => (
        <div
          class="landmark-hotspot-container"
          data-landmark-id={landmark.id}
          style={`
            left: ${landmark.clickableRect.x}px;
            top: ${landmark.clickableRect.y}px;
            width: ${landmark.clickableRect.w}px;
            height: ${landmark.clickableRect.h}px;
          `}
        >
          <a
            href={landmark.route}
            class="landmark-hotspot"
            data-landmark={landmark.id}
            data-astro-prefetch="false"
            aria-label={`Visit ${landmark.title_en}`}
          >
            <span class="sr-only">{landmark.title_en}</span>
          </a>
        </div>
      ))}

      <!-- Debug å±‚ï¼šæ˜¾ç¤ºè¾¹ç•Œå’Œé”šç‚¹ -->
      <svg class="debug-layer" id="debugLayer" viewBox={`0 0 ${DESIGN_W} ${DESIGN_H}`} preserveAspectRatio="none">
        <!-- æ ¸å¿ƒå»ºç­‘è¾¹ç•Œï¼ˆçº¢è‰²ï¼‰ -->
        <rect
          x={coreBuilding.building.rect.x}
          y={coreBuilding.building.rect.y}
          width={coreBuilding.building.rect.w}
          height={coreBuilding.building.rect.h}
          fill="none"
          stroke="red"
          stroke-width="2"
          stroke-dasharray="5,5"
        />
        <!-- æ ¸å¿ƒå»ºç­‘ä¸­å¿ƒç‚¹ -->
        <circle
          cx={coreBuilding.center.x}
          cy={coreBuilding.center.y}
          r="5"
          fill="red"
          opacity="0.8"
        />
        <text
          x={coreBuilding.center.x + 10}
          y={coreBuilding.center.y - 10}
          font-size="12"
          fill="red"
        >
          Core Center
        </text>

        {landmarks.map(landmark => (
          <>
            <!-- å»ºç­‘è¾¹ç•Œï¼ˆçº¢è‰²ï¼‰ -->
            <rect
              x={landmark.building.rect.x}
              y={landmark.building.rect.y}
              width={landmark.building.rect.w}
              height={landmark.building.rect.h}
              fill="none"
              stroke="red"
              stroke-width="2"
              stroke-dasharray="5,5"
            />
            <!-- æ ‡ç‰Œè¾¹ç•Œï¼ˆè“è‰²ï¼‰ -->
            <rect
              x={landmark.sign.rect.x}
              y={landmark.sign.rect.y}
              width={landmark.sign.rect.w}
              height={landmark.sign.rect.h}
              fill="none"
              stroke="blue"
              stroke-width="2"
              stroke-dasharray="5,5"
            />
            <!-- å¯ç‚¹å‡»åŒºåŸŸè¾¹ç•Œï¼ˆç»¿è‰²ï¼‰ -->
            <rect
              x={landmark.clickableRect.x}
              y={landmark.clickableRect.y}
              width={landmark.clickableRect.w}
              height={landmark.clickableRect.h}
              fill="none"
              stroke="lime"
              stroke-width="2"
              stroke-dasharray="5,5"
            />
            <!-- å…‰æŸç»ˆç‚¹é”šç‚¹ -->
            <circle
              cx={landmark.beamEnd.x}
              cy={landmark.beamEnd.y}
              r="5"
              fill="orange"
              opacity="0.8"
            />
            <text
              x={landmark.beamEnd.x + 10}
              y={landmark.beamEnd.y - 10}
              font-size="12"
              fill="orange"
            >
              {landmark.id}
            </text>
          </>
        ))}
      </svg>
    </div>

    <!-- å°äººè§’è‰²å¼•å¯¼ï¼ˆå»¶è¿ŸåŠ è½½ï¼‰ -->
    <div id="girl-runner" class="lazy-image" data-lazy-src="/girl/girl" data-lazy-alt="Guide Girl" data-lazy-style="width: 100%; height: auto; display: block;">
      <!-- img will be injected by IntersectionObserver -->
    </div>

    <!-- å¼¹çª—ç»„ä»¶ -->
    <div id="popup-overlay" class="popup-overlay">
      <div class="popup-container">
        <button class="popup-close" id="popupClose" aria-label="Close popup">Ã—</button>

        <!-- WeChat QR Code å¼¹çª— -->
        <div id="popup-wechat" class="popup-content">
          <h3 class="popup-title">å¾®ä¿¡æ‰«ä¸€æ‰«</h3>
          <div class="popup-qrcode-container lazy-image" data-lazy-src="/map/qrcode.png" data-lazy-alt="WeChat QR Code">
            <!-- img will be injected by IntersectionObserver -->
          </div>
        </div>

        <!-- Email å¼¹çª— -->
        <div id="popup-email" class="popup-content">
          <h3 class="popup-title">ç”µå­é‚®ç®±</h3>
          <div class="popup-text-container">
            <p class="popup-text" id="emailText">wyb3206@163.com</p>
          </div>
          <button class="popup-copy-btn" data-copy="wyb3206@163.com">
            <span class="copy-icon">ğŸ“‹</span>
            <span class="copy-text">å¤åˆ¶</span>
          </button>
        </div>

        <!-- å…¬ä¼—å·å¼¹çª— -->
        <div id="popup-gongzhonghao" class="popup-content">
          <h3 class="popup-title">å…¬ä¼—å·</h3>
          <div class="popup-text-container">
            <p class="popup-text" id="gongzhonghaoText">è´å¡”æ•°æ™ºæ‰€</p>
          </div>
          <button class="popup-copy-btn" data-copy="è´å¡”æ•°æ™ºæ‰€">
            <span class="copy-icon">ğŸ“‹</span>
            <span class="copy-text">å¤åˆ¶</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // ğŸ¯ å¯¼å…¥ girl-runner æ¨¡å—ï¼ˆAstro import æ–¹å¼ï¼‰
  import '../scripts/girl-runner.ts';
</script>

<style>
  /* ============================================
     ğŸ¯ é¦–å±å…³é”®æ ·å¼ï¼šé¿å… FOUC
     ============================================ */

  /* å…¨å± Viewport */
  .map-wrapper {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    margin: 0;
    padding: 0;
    background-color: #2a2419; /* æ·±æ£•è‰²ï¼Œæ¥è¿‘èƒŒæ™¯å›¾ä¸»è‰²è°ƒ */
  }

  /* ğŸ¯ Placeholder å±‚ï¼šçº¯è‰²èƒŒæ™¯ï¼Œç«‹å³æ˜¾ç¤º */
  .map-placeholder {
    position: fixed;
    inset: 0;
    z-index: 0;
    background: linear-gradient(135deg, #3d3225 0%, #2a2419 50%, #1f1810 100%);
    pointer-events: none;
  }

  /* ğŸ¯ èƒŒæ™¯å›¾ï¼šçº¯ CSS é“ºæ»¡ï¼Œä¸ä¾èµ– JS */
  .map-background {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    object-fit: cover; /* é“ºæ»¡è§†å£ï¼Œä¿æŒæ¯”ä¾‹ */
    object-position: center;
    z-index: 1;
    pointer-events: none;
    opacity: 0; /* åˆå§‹éšè—ï¼Œonload åæ·¡å…¥ */
    transition: opacity 0.6s ease-out;
  }

  /* èƒŒæ™¯å›¾åŠ è½½å®Œæˆåæ˜¾ç¤º */
  .map-background.loaded {
    opacity: 1;
  }

  /* Debug åˆ‡æ¢æŒ‰é’®ï¼ˆå·¦ä¸Šè§’ï¼Œfixed overlayï¼‰ */
  .debug-toggle-btn {
    position: fixed;
    top: 62px;
    left: 16px;
    z-index: 50;
    background: transparent;
    border: 1px solid var(--ink-main);
    padding: 0.5rem;
    cursor: pointer;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    opacity: 0.6;
  }

  .debug-toggle-btn:hover {
    opacity: 1;
    background-color: rgba(31, 31, 31, 0.05);
  }

  .debug-toggle-btn.active {
    background-color: rgba(31, 31, 31, 0.1);
    opacity: 1;
  }

  .debug-icon {
    font-size: 0.875rem;
  }

  /* å›ºå®šç”»å¸ƒ mapStageï¼ˆäº¤äº’å±‚ï¼‰*/
  .map-canvas {
    width: 1376px;
    height: 768px;
    position: absolute;
    left: 50%;
    top: 50%;
    transform-origin: center center;
    z-index: 10; /* åœ¨èƒŒæ™¯å›¾ä¹‹ä¸Š */
    /* transform ç”± JS è®¡ç®—: translate(-50%, -50%) scale(scale) */
  }

  /* ä¸»æ ‡é¢˜ */
  .hero-title {
    position: absolute;
    transform: translateX(-50%);
    z-index: 5;
    text-align: center;
    pointer-events: none;
    /* ğŸ”§ å›ºå®šå°ºå¯¸ï¼Œé¿å…å‚ä¸ LCP ç«äº‰ */
    width: 600px;
    height: 80px;
    contain: layout style paint; /* ğŸ”§ éš”ç¦»å¸ƒå±€ï¼Œä¸å½±å“ LCP */
  }

  .hero-subtitle {
    font-family: var(--font-serif);
    font-size: 1rem;
    letter-spacing: 0.15em;
    color: #d4c4a8;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    font-weight: 400;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    /* ğŸ”§ å›ºå®šé«˜åº¦ */
    height: 24px;
    line-height: 24px;
  }

  .hero-main {
    font-family: var(--font-serif);
    font-size: 1.85rem;
    letter-spacing: 0.1em;
    color: #e8dcc0;
    text-transform: uppercase;
    font-weight: 600;
    text-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    line-height: 1.2;
    /* ğŸ”§ å›ºå®šé«˜åº¦ */
    height: 48px;
    line-height: 48px;
  }

  /* å…‰æŸå±‚ï¼ˆå•ä¸€ SVG è¦†ç›–å±‚ï¼‰ */
  .beam-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 30;
    overflow: visible;
  }

  #coreBeacon {
    pointer-events: all;
    cursor: pointer;
  }

  /* å…‰æŸè·¯å¾„ï¼šä¸è¦ç”¨ CSS è¦†ç›– SVG stroke å±æ€§ */
  .beam-path {
    /* ç§»é™¤äº† stroke: unset; é¿å…è¦†ç›– SVG çš„ stroke="url(#...)" */
    transition: opacity 0.8s ease-out;
  }

  /* æ¿€æ´»çŠ¶æ€ï¼šå¢å¼ºäº®åº¦ */
  .beam-group.active .beam-outer {
    opacity: 0.55 !important;
    transition: opacity 1s ease-out;
  }

  .beam-group.active .beam-mid {
    opacity: 0.7 !important;
    transition: opacity 1s ease-out 0.1s;
  }

  .beam-group.active .beam-inner {
    opacity: 0.9 !important;
    transition: opacity 1s ease-out 0.2s;
  }

  /* æµåŠ¨é«˜å…‰åŠ¨ç”»ï¼ˆç™½è‰²æµåŠ¨ï¼Œæå¿«ï¼‰ */
  .beam-highlight {
    transition: opacity 0.6s ease;
  }

  .beam-group.active .beam-highlight {
    opacity: 0.6 !important;
    animation: highlightFlow 1s linear infinite 0.5s;
  }

  @keyframes highlightFlow {
    to {
      stroke-dashoffset: -200;
    }
  }

  /* æµåŠ¨ç²’å­æ•ˆæœï¼ˆç™½è‰²å…‰ç‚¹ï¼Œæå¿«ï¼‰ */
  .beam-particle {
    transition: opacity 0.6s ease;
  }

  .beam-group.active .beam-particle {
    opacity: 0.65 !important;
  }

  /* å»ºç­‘å®¹å™¨ï¼ˆæ”¯æŒ transformï¼‰ */
  .building-container {
    position: absolute;
    transform-origin: center center;
    z-index: 8;
    transition: transform 220ms cubic-bezier(0.2, 0.9, 0.2, 1.2);
    /* ğŸ”§ å¼ºåˆ¶ä¿®å¤ï¼šç¡®ä¿å®¹å™¨å¯è§ */
    overflow: visible !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* ç¡®ä¿ picture æ ‡ç­¾ä¸å½±å“å¸ƒå±€ */
  .building-container picture,
  .sign-container picture,
  #girl-runner picture {
    display: block;
    width: 100%;
    height: 100%;
  }

  .core-container {
    pointer-events: none;
  }

  /* å»ºç­‘å±‚æ ·å¼ */
  .building-layer {
    position: relative !important; /* ğŸ”§ å¼ºåˆ¶ç›¸å¯¹å®šä½ */
    width: 100% !important;
    height: 100% !important;
    object-fit: contain;
    pointer-events: none;
    transition: filter 220ms ease;
    display: block !important;
    /* ğŸ”§ å¼ºåˆ¶ä¿®å¤ï¼šç¡®ä¿å›¾ç‰‡å¯è§ */
    opacity: 1 !important;
    visibility: visible !important;
    z-index: 1 !important;
  }

  /* ğŸ”§ LCP ç›®æ ‡å…ƒç´ ï¼šæœ€é«˜ä¼˜å…ˆçº§ */
  .lcp-target {
    content-visibility: visible !important; /* ğŸ”§ å¼ºåˆ¶å¯è§ï¼Œä¸å»¶è¿Ÿæ¸²æŸ“ */
  }

  /* å»ºç­‘ hover é˜´å½± */
  .building-layer.hover {
    filter: drop-shadow(0 10px 14px rgba(0, 0, 0, 0.22));
  }

  /* æ ‡ç‰Œå®¹å™¨ï¼ˆç‹¬ç«‹æ¸²æŸ“ï¼‰ */
  .sign-container {
    position: absolute;
    transform-origin: center center;
    z-index: 9;
    transition: transform 220ms cubic-bezier(0.2, 0.9, 0.2, 1.2);
    /* ğŸ”§ å¼ºåˆ¶ä¿®å¤ï¼šç¡®ä¿å®¹å™¨å¯è§ */
    overflow: visible !important;
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* æ ‡ç‰Œ SVG */
  .sign-bg {
    position: relative !important; /* ğŸ”§ å¼ºåˆ¶ç›¸å¯¹å®šä½ */
    width: 100% !important;
    height: 100% !important;
    object-fit: contain;
    pointer-events: none;
    display: block !important;
    /* ğŸ”§ å¼ºåˆ¶ä¿®å¤ï¼šç¡®ä¿å›¾ç‰‡å¯è§ */
    opacity: 1 !important;
    visibility: visible !important;
    z-index: 1 !important;
  }

  /* ğŸ› Debug æ¨¡å¼ï¼šé«˜äº®æ˜¾ç¤ºå®¹å™¨å’Œå›¾ç‰‡ */
  .debug-highlight .building-container,
  .debug-highlight .sign-container {
    outline: 3px solid red !important;
    z-index: 9999 !important;
  }

  .debug-highlight .building-layer,
  .debug-highlight .sign-bg {
    outline: 2px solid lime !important;
    z-index: 9999 !important;
  }

  /* Resume æ ‡è¯†ï¼ˆä¸­å¤®åº•éƒ¨ï¼‰ */
  .resume-badge {
    position: absolute;
    z-index: 10;
    transform-origin: center center;
    transition: transform 220ms cubic-bezier(0.2, 0.9, 0.2, 1.2);
    cursor: pointer;
    text-decoration: none;
    display: block;
  }

  .resume-badge:hover {
    transform: translateY(-6px) scale(1.05);
  }

  .resume-badge-img {
    position: absolute;
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
    opacity: 0.9;
    transition: opacity 0.3s ease, filter 220ms ease;
  }

  .resume-badge:hover .resume-badge-img {
    opacity: 1;
    filter: drop-shadow(0 10px 14px rgba(0, 0, 0, 0.22));
  }

  /* ç¤¾äº¤åª’ä½“å›¾æ ‡å®¹å™¨ */
  .social-icons-container {
    position: absolute;
    z-index: 11;
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* å•ä¸ªç¤¾äº¤å›¾æ ‡ */
  .social-icon {
    position: relative;
    width: 32px;
    height: 32px;
    display: block;
    cursor: pointer;
    text-decoration: none;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .social-icon:hover {
    transform: translateY(-8px);
    animation: iconBounce 0.6s ease-in-out;
  }

  .social-icon-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
    opacity: 0.85;
    transition: opacity 0.3s ease, filter 0.3s ease;
  }

  .social-icon:hover .social-icon-img {
    opacity: 1;
    filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.15));
  }

  /* å¼¹è·³åŠ¨ç”» */
  @keyframes iconBounce {
    0%, 100% {
      transform: translateY(-8px);
    }
    50% {
      transform: translateY(-14px);
    }
  }

  /* å¯ç‚¹å‡»çƒ­åŒºå®¹å™¨ */
  .landmark-hotspot-container {
    position: absolute;
    z-index: 15;
  }

  /* å¯ç‚¹å‡»çƒ­åŒº */
  .landmark-hotspot {
    position: absolute;
    inset: 0;
    z-index: 15;
    cursor: pointer;
  }

  /* å°äººè§’è‰²å¼•å¯¼ */
  #girl-runner {
    position: fixed;
    left: 0;
    top: 0;
    width: 72px;
    height: auto;
    pointer-events: none;
    z-index: 15;
    will-change: transform;
  }

  #girl-runner img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Debug å±‚ */
  .debug-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .debug-layer.visible {
    opacity: 1;
  }

  /* å±å¹•é˜…è¯»å™¨ä¸“ç”¨ */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  /* å°Šé‡ç”¨æˆ·åŠ¨ç”»åå¥½ */
  @media (prefers-reduced-motion: reduce) {
    .beam-path,
    .beam-highlight {
      animation: none !important;
      transition: opacity 0.3s ease;
    }

    .beam-highlight {
      stroke-dasharray: none !important;
      stroke-dashoffset: 0 !important;
    }

    circle animate {
      display: none;
    }

    .building-layer,
    .sign-container {
      transition: none !important;
    }

    .social-icon,
    .social-icon:hover {
      animation: none !important;
      transition: none !important;
    }
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    /* ç§»åŠ¨ç«¯éšè—ç¤¾äº¤å›¾æ ‡ï¼ˆé¿å…é®æŒ¡ï¼‰ */
    .social-icons-container {
      display: none;
    }

    /* ç§»åŠ¨ç«¯æ ‡é¢˜è°ƒæ•´ */
    .hero-subtitle {
      font-size: 0.625rem;
      letter-spacing: 0.1em;
    }

    .hero-main {
      font-size: 1.25rem;
      letter-spacing: 0.08em;
    }
  }

  /* å¼¹çª—æ ·å¼ */
  .popup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .popup-overlay.active {
    display: flex;
    opacity: 1;
  }

  .popup-container {
    position: relative;
    background: var(--bg-parchment);
    border: 2px solid var(--ink-main);
    padding: 2.5rem 2rem 2rem;
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 4px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transform: scale(0.9);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .popup-overlay.active .popup-container {
    transform: scale(1);
  }

  .popup-close {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    font-size: 2rem;
    line-height: 1;
    color: var(--ink-soft);
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    transition: color 0.3s ease, transform 0.3s ease;
  }

  .popup-close:hover {
    color: var(--ink-main);
    transform: scale(1.1);
  }

  .popup-content {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .popup-content.active {
    display: flex;
  }

  .popup-title {
    font-family: var(--font-zh-display);
    font-size: 1.5rem;
    color: var(--ink-main);
    margin: 0;
    font-weight: 400;
  }

  .popup-qrcode-container,
  .popup-qrcode {
    width: 280px;
    height: 280px;
    object-fit: contain;
    border: 1px solid rgba(74, 74, 74, 0.2);
    background: white;
    padding: 0.5rem;
  }

  .popup-text-container {
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(74, 74, 74, 0.2);
    padding: 1rem 1.5rem;
    border-radius: 4px;
    min-width: 280px;
  }

  .popup-text {
    font-family: var(--font-zh-body);
    font-size: 1.125rem;
    color: var(--ink-main);
    margin: 0;
    text-align: center;
    user-select: all;
  }

  .popup-copy-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--ink-main);
    color: var(--bg-parchment);
    border: none;
    padding: 0.75rem 1.5rem;
    font-family: var(--font-sans);
    font-size: 1rem;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s ease;
  }

  .popup-copy-btn:hover {
    background: var(--ink-soft);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .popup-copy-btn:active {
    transform: translateY(0);
  }

  .popup-copy-btn.copied {
    background: #4caf50;
  }

  .copy-icon {
    font-size: 1.25rem;
  }

  .copy-text {
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .popup-container {
      padding: 2rem 1.5rem 1.5rem;
    }

    .popup-title {
      font-size: 1.25rem;
    }

    .popup-qrcode {
      width: 220px;
      height: 220px;
    }

    .popup-text-container {
      min-width: 240px;
    }

    .popup-text {
      font-size: 1rem;
    }
  }
</style>

<script>
  // ç¡®ä¿åœ¨ View Transitions å¯¼èˆªæ—¶ä¹Ÿèƒ½æ­£ç¡®æ‰§è¡Œ
  document.addEventListener('astro:page-load', () => {
    console.log('ğŸ  é¦–é¡µè„šæœ¬åŠ è½½');

    // ============================================
    // ğŸ¯ èƒŒæ™¯å›¾æ·¡å…¥ï¼šonload åæ˜¾ç¤º
    // ============================================
    const bgImage = document.getElementById('mapBackground');
    if (bgImage) {
      // å¦‚æœå›¾ç‰‡å·²ç»ä»ç¼“å­˜åŠ è½½å®Œæˆ
      if (bgImage.complete && bgImage.naturalHeight !== 0) {
        console.log('âœ… èƒŒæ™¯å›¾å·²ä»ç¼“å­˜åŠ è½½');
        bgImage.classList.add('loaded');
      } else {
        // ç›‘å¬å›¾ç‰‡åŠ è½½å®Œæˆ
        bgImage.addEventListener('load', () => {
          console.log('âœ… èƒŒæ™¯å›¾åŠ è½½å®Œæˆï¼Œå¼€å§‹æ·¡å…¥');
          bgImage.classList.add('loaded');
        });

        bgImage.addEventListener('error', () => {
          console.error('âŒ èƒŒæ™¯å›¾åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤º placeholder');
          // ä¿ç•™ placeholderï¼Œä¸æ·»åŠ  loaded class
        });
      }
    }

    // ============================================
    // ğŸ¯ LCP (Largest Contentful Paint) ç›‘æ§
    // ============================================
    if ('PerformanceObserver' in window) {
      try {
        const lcpObserver = new PerformanceObserver((list) => {
          const entries = list.getEntries();
          const lastEntry = entries[entries.length - 1];

          console.log('ğŸ“Š LCP æ£€æµ‹ç»“æœ:');
          console.log(`  â±ï¸  æ—¶é—´: ${lastEntry.renderTime || lastEntry.loadTime}ms`);
          console.log(`  ğŸ¯ å…ƒç´ :`, lastEntry.element);
          console.log(`  ğŸ“ å°ºå¯¸: ${lastEntry.size}pxÂ²`);
          console.log(`  ğŸ”— URL: ${lastEntry.url || 'N/A'}`);

          // æ£€æŸ¥æ˜¯å¦æ˜¯é¢„æœŸçš„èƒŒæ™¯å›¾
          const isBackgroundImg = lastEntry.element?.classList?.contains('map-background');
          if (isBackgroundImg) {
            console.log('  âœ… LCP å·²æ­£ç¡®é”å®šåˆ°èƒŒæ™¯å›¾ï¼');
          } else {
            console.warn('  âš ï¸  LCP ä¸æ˜¯èƒŒæ™¯å›¾ï¼Œè¯·æ£€æŸ¥ï¼');
            console.warn('  å½“å‰ LCP å…ƒç´ :', lastEntry.element?.tagName, lastEntry.element?.className);
          }
        });

        lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });

        // é¡µé¢å¸è½½æ—¶è¾“å‡ºæœ€ç»ˆ LCP
        window.addEventListener('beforeunload', () => {
          lcpObserver.disconnect();
        });
      } catch (e) {
        console.warn('âš ï¸  LCP ç›‘æ§åˆå§‹åŒ–å¤±è´¥:', e);
      }
    }

    // ============================================
    // ğŸ¯ ç»Ÿä¸€çš„"å…œåº•å¿…æˆåŠŸ"å›¾ç‰‡åŠ è½½å™¨
    // ============================================

    /**
     * åˆ›å»ºå¸¦ fallback çš„ img å…ƒç´ ï¼ˆç®€åŒ–ç‰ˆï¼Œç¡®ä¿è¯·æ±‚çœŸæ­£å‘å‡ºï¼‰
     * @param {string} basePath - è·¯å¾„ï¼ˆå¯èƒ½å¸¦æ‰©å±•åï¼‰
     * @param {string} alt - å›¾ç‰‡ alt æ–‡æœ¬
     * @param {string} className - CSS ç±»å
     * @param {string} inlineStyle - å†…è”æ ·å¼ï¼ˆå¯é€‰ï¼‰
     * @param {string} fetchPriority - åŠ è½½ä¼˜å…ˆçº§ï¼ˆhigh/low/autoï¼‰
     * @param {Function} onSuccess - æˆåŠŸå›è°ƒ
     * @param {Function} onAllFailed - æ‰€æœ‰æ ¼å¼éƒ½å¤±è´¥æ—¶çš„å›è°ƒ
     * @returns {HTMLImageElement}
     */
    function makeImgWithFallback(basePath, alt, className, inlineStyle, fetchPriority, onSuccess, onAllFailed) {
      const img = document.createElement('img');
      img.alt = alt || '';
      img.decoding = 'async';

      // ğŸ”§ æ ¹æ® fetchpriority è®¾ç½®åŠ è½½ç­–ç•¥
      if (fetchPriority === 'high') {
        img.loading = 'eager';
        img.fetchPriority = 'high';
        console.log(`ğŸ¯ [LCP å€™é€‰] ${basePath}`);
      } else if (fetchPriority === 'medium') {
        img.loading = 'eager';
        img.fetchPriority = 'high'; // medium ä¹Ÿç”¨ highï¼Œç¡®ä¿å¿«é€ŸåŠ è½½
        console.log(`ğŸ“‹ [Resume] ${basePath}`);
      } else {
        // ğŸ”§ ä¿®å¤ï¼šæ‰€æœ‰å›¾ç‰‡éƒ½ç”¨ eagerï¼Œåªæ˜¯å»¶è¿Ÿæ—¶é—´ä¸åŒ
        img.loading = 'eager'; // æ”¹ä¸º eagerï¼Œç¡®ä¿åŠ è½½
        img.fetchPriority = 'low';
      }

      if (className) img.className = className;
      if (inlineStyle) img.style.cssText = inlineStyle;

      // ğŸ”§ æ£€æŸ¥è·¯å¾„æ˜¯å¦å·²ç»å¸¦æ‰©å±•å
      const hasExtension = /\.(avif|webp|svg|png|jpg|jpeg|gif)$/i.test(basePath);
      // ç§»åŠ¨ç«¯ä¼˜å…ˆä½¿ç”¨ SVGï¼Œé¿å…é€æ˜èƒŒæ™¯è¢«æ …æ ¼åŒ–æˆé»‘åº•
      const preferSvgOnMobile = window.matchMedia('(max-width: 768px)').matches;
      const preferSvg = preferSvgOnMobile && (basePath.startsWith('/map/') || basePath.startsWith('/girl/'));

      let candidates = [];
      if (hasExtension) {
        candidates = [basePath];
        console.log(`ğŸ” è·¯å¾„å·²å¸¦æ‰©å±•å: ${basePath}`);
      } else {
        candidates = preferSvg
          ? [
            `${basePath}.svg`,
            `${basePath}.avif`,
            `${basePath}.webp`,
            `${basePath}.png`,
          ]
          : [
            `${basePath}.avif`,
            `${basePath}.webp`,
            `${basePath}.svg`,
            `${basePath}.png`,
          ];
        console.log(`ğŸ” è·¯å¾„æ— æ‰©å±•åï¼Œå€™é€‰:`, candidates);
      }

      console.log(`ğŸ“‹ [${basePath}] å€™é€‰åˆ—è¡¨:`, candidates);

      let currentIndex = 0;

      const tryNext = () => {
        if (currentIndex >= candidates.length) {
          console.error(`âŒ [${basePath}] æ‰€æœ‰æ ¼å¼éƒ½å¤±è´¥`);
          if (onAllFailed) onAllFailed();
          return;
        }

        const currentSrc = candidates[currentIndex];
        console.log(`ğŸ”„ [${currentIndex + 1}/${candidates.length}] å°è¯•: ${currentSrc}`);

        img.onload = () => {
          console.log(`âœ… [${currentIndex + 1}/${candidates.length}] æˆåŠŸ: ${currentSrc}`);
          console.log(`ğŸ‰ æœ€ç»ˆæˆåŠŸ URL: ${currentSrc}`);
          if (onSuccess) onSuccess();
        };

        img.onerror = () => {
          console.warn(`âš ï¸ [${currentIndex + 1}/${candidates.length}] å¤±è´¥: ${currentSrc}`);
          currentIndex++;
          tryNext();
        };

        img.src = currentSrc;
      };

      // ç«‹å³å¼€å§‹å°è¯•ç¬¬ä¸€ä¸ªå€™é€‰
      tryNext();

      return img;
    }

    // ============================================
    // ğŸ¯ ç»Ÿä¸€åŠ è½½é€»è¾‘
    // ============================================

    /**
     * åŠ è½½å•ä¸ªå®¹å™¨çš„å›¾ç‰‡
     * @param {HTMLElement} container - å®¹å™¨å…ƒç´ 
     * @param {number} delay - å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     */
    function loadImage(container, delay = 0) {
      const basePath = container.getAttribute('data-lazy-src') || container.getAttribute('data-eager-src');
      const alt = container.getAttribute('data-lazy-alt') || container.getAttribute('data-eager-alt') || '';
      const className = container.getAttribute('data-lazy-class') || container.getAttribute('data-eager-class') || '';
      const inlineStyle = container.getAttribute('data-lazy-style') || container.getAttribute('data-eager-style') || '';
      const fetchPriority = container.getAttribute('data-fetchpriority') || 'auto'; // ğŸ”§ è¯»å–ä¼˜å…ˆçº§

      // ğŸ”§ ä¿®å¤ç‚¹ 1ï¼šbasePath ä¸ºç©ºæ—¶ï¼Œæ— éœ€æ¸…ç† loadingï¼ˆå› ä¸ºè¿˜æ²¡è®¾ç½®ï¼‰
      if (!basePath) {
        console.error('âŒ å®¹å™¨ç¼ºå°‘ basePath:', container);
        return;
      }

      // ğŸ”§ ä¿®å¤ç‚¹ 2ï¼šå·²åŠ è½½æˆ–åŠ è½½ä¸­ï¼Œç›´æ¥è¿”å›
      if (container.dataset.loaded || container.dataset.loading) {
        console.log(`â­ï¸ è·³è¿‡å·²åŠ è½½/åŠ è½½ä¸­çš„å®¹å™¨: ${basePath}`);
        return;
      }

      // è®¾ç½® loading æ ‡å¿—
      container.dataset.loading = 'true';
      console.log(`ğŸ”„ å‡†å¤‡åŠ è½½å›¾ç‰‡ï¼ˆå»¶è¿Ÿ ${delay}msï¼Œä¼˜å…ˆçº§ ${fetchPriority}ï¼‰: ${basePath}`);
      console.log(`   å®¹å™¨ä¿¡æ¯:`, {
        id: container.id || container.getAttribute('data-landmark-id'),
        className: container.className,
        width: container.offsetWidth,
        height: container.offsetHeight,
        visible: container.offsetParent !== null
      });

      // ğŸ”§ ä¿®å¤ç‚¹ 3ï¼šè¶…æ—¶ä¿æŠ¤ï¼ˆ10 ç§’ï¼‰
      const loadingTimeoutId = setTimeout(() => {
        if (container.dataset.loading && !container.dataset.loaded) {
          console.error(`â±ï¸ åŠ è½½è¶…æ—¶ï¼ˆ10 ç§’ï¼‰ï¼Œå¼ºåˆ¶é‡Šæ”¾ loading: ${basePath}`);
          delete container.dataset.loading;
          container.dataset.loadFailed = 'true';
        }
      }, 10000);

      // ğŸ”§ è¾…åŠ©å‡½æ•°ï¼šæ¸…ç† loading çŠ¶æ€
      const cleanupLoading = (reason) => {
        clearTimeout(loadingTimeoutId);
        delete container.dataset.loading;
        console.log(`ğŸ§¹ æ¸…ç† loading çŠ¶æ€: ${basePath} (åŸå› : ${reason})`);
      };

      setTimeout(() => {
        // ğŸ”§ ä¿®å¤ç‚¹ 4ï¼šåœ¨ setTimeout å†…æ£€æŸ¥åˆ°å·²åŠ è½½ï¼Œéœ€è¦æ¸…ç† loading
        if (container.dataset.loaded) {
          console.log(`â­ï¸ å®¹å™¨å·²åŠ è½½ï¼Œè·³è¿‡: ${basePath}`);
          cleanupLoading('å·²åŠ è½½');
          return;
        }

        console.log(`ğŸ“¦ å¼€å§‹åˆ›å»ºå›¾ç‰‡: ${basePath}`);

        // ğŸ”§ ä¿®å¤ç‚¹ 5ï¼šä¼ é€’ fetchPriority, onSuccess å’Œ onAllFailed å›è°ƒ
        const img = makeImgWithFallback(
          basePath,
          alt,
          className,
          inlineStyle,
          fetchPriority, // ğŸ”§ ä¼ é€’ä¼˜å…ˆçº§
          // onSuccess å›è°ƒ
          () => {
            console.log(`âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ: ${basePath}`);
            container.dataset.loaded = 'true';
            cleanupLoading('åŠ è½½æˆåŠŸ');
            container.appendChild(img);

            // ğŸ› è¯Šæ–­ï¼šæ£€æŸ¥å›¾ç‰‡æ·»åŠ åçš„çŠ¶æ€
            setTimeout(() => {
              const imgRect = img.getBoundingClientRect();
              const containerRect = container.getBoundingClientRect();

              console.log(`âœ… å›¾ç‰‡å·²æ·»åŠ åˆ°å®¹å™¨:`, {
                src: img.src,
                container: container.id || container.getAttribute('data-landmark-id'),
                childCount: container.children.length,
                imgVisible: imgRect.width > 0 && imgRect.height > 0,
                containerVisible: containerRect.width > 0 && containerRect.height > 0
              });
            }, 50);
          },
          // onAllFailed å›è°ƒ
          () => {
            console.error(`âŒ æ‰€æœ‰æ ¼å¼éƒ½åŠ è½½å¤±è´¥ï¼Œéšè—å®¹å™¨: ${basePath}`);
            container.dataset.loadFailed = 'true';
            cleanupLoading('æ‰€æœ‰æ ¼å¼å¤±è´¥');
            container.style.opacity = '0';
            container.style.pointerEvents = 'none';
          }
        );

        // ğŸ”§ ä¿®å¤ç‚¹ 6ï¼šç«‹å³å°†å›¾ç‰‡æ·»åŠ åˆ° DOMï¼Œè§¦å‘åŠ è½½
        // ï¼ˆæ³¨æ„ï¼šè¿™é‡Œå…ˆæ·»åŠ ç©ºçš„ imgï¼Œsrc ä¼šåœ¨ makeImgWithFallback ä¸­è®¾ç½®ï¼‰
        // ä¸ï¼Œåº”è¯¥åœ¨ onSuccess ä¸­æ·»åŠ 
      }, delay);
    }

    // ============================================
    // ğŸ¯ ç«‹å³åŠ è½½ eager å…ƒç´ 
    // ============================================
    const eagerImages = document.querySelectorAll('.eager-image');
    console.log(`âš¡ æ‰¾åˆ° ${eagerImages.length} ä¸ª eager å…ƒç´ `);

    // ğŸ”§ ä¸‰çº§ä¼˜å…ˆçº§åˆ†ç»„
    const highPriorityImages = [];    // LCP å€™é€‰ï¼šworkshop building
    const mediumPriorityImages = [];  // Resume
    const lowPriorityImages = [];     // ç¤¾äº¤å›¾æ ‡ã€å…¶ä»– signs

    eagerImages.forEach((container) => {
      const fetchPriority = container.getAttribute('data-fetchpriority') || 'auto';
      const basePath = container.getAttribute('data-eager-src');

      if (fetchPriority === 'high') {
        highPriorityImages.push({ container, basePath });
      } else if (fetchPriority === 'medium') {
        mediumPriorityImages.push({ container, basePath });
      } else {
        lowPriorityImages.push({ container, basePath });
      }
    });

    console.log(`\nğŸ¯ åŠ è½½ä¼˜å…ˆçº§åˆ†ç»„:`);
    console.log(`   1ï¸âƒ£ é«˜ä¼˜å…ˆçº§ (LCP): ${highPriorityImages.length} ä¸ª`);
    console.log(`   2ï¸âƒ£ ä¸­ä¼˜å…ˆçº§ (Resume): ${mediumPriorityImages.length} ä¸ª`);
    console.log(`   3ï¸âƒ£ ä½ä¼˜å…ˆçº§ (Social): ${lowPriorityImages.length} ä¸ª`);

    // ğŸ”§ ç¬¬ä¸€æ‰¹ï¼šé«˜ä¼˜å…ˆçº§ï¼ˆLCP å€™é€‰ï¼‰- ç«‹å³åŠ è½½
    console.log(`\nâš¡ ç¬¬ä¸€æ‰¹ï¼šLCP å€™é€‰ (ç«‹å³)`);
    highPriorityImages.forEach(({ container, basePath }, index) => {
      console.log(`   [${index}] ${basePath}`);
      loadImage(container, 0);
    });

    // ğŸ”§ ç¬¬äºŒæ‰¹ï¼šä¸­ä¼˜å…ˆçº§ï¼ˆResumeï¼‰- å»¶è¿Ÿ 200ms
    console.log(`\nğŸ“‹ ç¬¬äºŒæ‰¹ï¼šResume (å»¶è¿Ÿ 200ms)`);
    setTimeout(() => {
      mediumPriorityImages.forEach(({ container, basePath }, index) => {
        console.log(`   [${index}] ${basePath}`);
        loadImage(container, 0); // 200ms åç«‹å³åŠ è½½
      });
    }, 200);

    // ğŸ”§ ç¬¬ä¸‰æ‰¹ï¼šä½ä¼˜å…ˆçº§ï¼ˆç¤¾äº¤å›¾æ ‡ã€signsï¼‰- å»¶è¿Ÿ 500msï¼Œé”™å¼€åŠ è½½
    console.log(`\nğŸŒ ç¬¬ä¸‰æ‰¹ï¼šç¤¾äº¤å›¾æ ‡ (å»¶è¿Ÿ 500msï¼Œé—´éš” 80ms)`);
    setTimeout(() => {
      lowPriorityImages.forEach(({ container, basePath }, index) => {
        console.log(`   [${index}] ${basePath}`);
        loadImage(container, index * 80); // æ¯ä¸ªé—´éš” 80ms
      });
    }, 500);

    // ============================================
    // ğŸ¯ IntersectionObserver å»¶è¿ŸåŠ è½½ lazy å…ƒç´ 
    // ============================================
    const lazyImageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const container = entry.target;
          const basePath = container.getAttribute('data-lazy-src');
          console.log(`ğŸ‘ï¸ å…ƒç´ è¿›å…¥è§†å£: ${basePath}`);

          // ğŸ”§ lazy å›¾ç‰‡å¿«é€ŸåŠ è½½ï¼Œé¿å…è¶…æ—¶
          const randomDelay = Math.floor(Math.random() * 200) + 300; // 300-500ms éšæœºå»¶è¿Ÿ
          loadImage(container, randomDelay);

          // åœæ­¢è§‚å¯Ÿè¯¥å…ƒç´ 
          observer.unobserve(container);
        }
      });
    }, {
      rootMargin: '800px 0px', // ğŸ”§ ä» 1200px å‡å°‘åˆ° 800pxï¼Œå‡å°‘é¢„åŠ è½½é‡
      threshold: 0
    });

    // ğŸ¯ è§‚å¯Ÿæ‰€æœ‰ lazy å…ƒç´ 
    const lazyImages = document.querySelectorAll('.lazy-image');
    console.log(`ğŸ–¼ï¸  æ‰¾åˆ° ${lazyImages.length} ä¸ª lazy å…ƒç´ `);

    lazyImages.forEach((img, index) => {
      const basePath = img.getAttribute('data-lazy-src');
      const id = img.getAttribute('data-landmark-id') || img.id || `unnamed-${index}`;
      console.log(`  [${index}] ${id}: ${basePath}`);
      lazyImageObserver.observe(img);
    });

    console.log(`âœ… å·²è§‚å¯Ÿ ${lazyImages.length} ä¸ªå»¶è¿ŸåŠ è½½å…ƒç´ `);

    // ğŸ¯ å…œåº•æœºåˆ¶ï¼šé¡µé¢åŠ è½½å®Œæˆ 2 ç§’åï¼Œå¼ºåˆ¶åŠ è½½æ‰€æœ‰æœªåŠ è½½çš„å…ƒç´ 
    window.addEventListener('load', () => {
      setTimeout(() => {
        const unloadedImages = document.querySelectorAll('.lazy-image:not([data-loaded]):not([data-loading]), .eager-image:not([data-loaded]):not([data-loading])');
        if (unloadedImages.length > 0) {
          console.warn(`âš ï¸ å‘ç° ${unloadedImages.length} ä¸ªæœªè§¦å‘çš„åŠ è½½å›¾ç‰‡ï¼Œæ‰§è¡Œå…œåº•åŠ è½½`);
          unloadedImages.forEach(container => {
            const basePath = container.getAttribute('data-lazy-src') || container.getAttribute('data-eager-src');
            console.log(`ğŸ”§ å…œåº•åŠ è½½: ${basePath}`);
            loadImage(container, 0); // ç«‹å³åŠ è½½ï¼Œæ— å»¶è¿Ÿ
          });
        } else {
          console.log(`âœ… æ‰€æœ‰å›¾ç‰‡å·²è§¦å‘æˆ–å·²åŠ è½½`);
        }
      }, 2000);
    });

    // ============================================
    // ä»¥ä¸‹æ˜¯åŸæœ‰ä»£ç 
    // ============================================

    // æ£€æŸ¥éŸ³ä¹çŠ¶æ€
    if (window.__globalAudio) {
      console.log('ğŸµ é¦–é¡µæ£€æµ‹åˆ°å…¨å±€éŸ³é¢‘å¯¹è±¡ï¼ŒçŠ¶æ€:', window.__globalAudio.paused ? 'â¸ï¸ æš‚åœ' : 'â–¶ï¸ æ’­æ”¾ä¸­');
    } else {
      console.warn('âš ï¸ é¦–é¡µæœªæ£€æµ‹åˆ°å…¨å±€éŸ³é¢‘å¯¹è±¡');
    }

    // åœ°æ ‡é…ç½®æ•°æ®ï¼ˆä¸é¡¶éƒ¨ frontmatter ä¿æŒåŒæ­¥ï¼‰
    const landmarks = [
      {
        id: 'workshop',
        building: {
          transform: { scale: 4.1, dx: 0, dy: -140 },
          hoverScale: 1.06  // æ‚¬åœç¼©æ”¾å€æ•°
        },
        sign: {
          transform: { scale: 2.1, dx: 0, dy: 0 },
          hoverScale: 1.04  // æ‚¬åœç¼©æ”¾å€æ•°
        },
      },
      {
        id: 'knowledge',
        building: {
          transform: { scale: 1.75, dx: 0, dy: -90 },
          hoverScale: 1.05
        },
        sign: {
          transform: { scale: 2.1, dx: 0, dy: 0 },
          hoverScale: 1.04
        },
      },
      {
        id: 'archives',
        building: {
          transform: { scale: 1.7, dx: 0, dy: 0 },
          hoverScale: 1.05
        },
        sign: {
          transform: { scale: 1.65, dx: 0, dy: 0 },
          hoverScale: 1.04
        },
      },
      {
        id: 'command',
        building: {
          transform: { scale: 1.1, dx: 0, dy: 0 },
          hoverScale: 1.05
        },
        sign: {
          transform: { scale: 1.6, dx: 0, dy: 0 },
          hoverScale: 1.04
        },
      },
    ];

    // ç”»å¸ƒç¼©æ”¾é€»è¾‘
    const DESIGN_W = 1920;
    const DESIGN_H = 1072;

    const mapCanvas = document.getElementById('mapCanvas');
    const debugLayer = document.getElementById('debugLayer');
    const debugToggle = document.getElementById('debugToggle');
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Debug æ¨¡å¼çŠ¶æ€
    let debugMode = false;

    // å…‰æŸç³»ç»Ÿï¼šhover äº¤äº’
    const coreBeacon = document.getElementById('coreBeacon');
    const beamGroups = document.querySelectorAll('.beam-group');

    console.log('æ‰¾åˆ°å…‰æŸç»„æ•°é‡:', beamGroups.length);

    // å…‰æŸçŠ¶æ€ç®¡ç†ï¼šé˜²æ­¢å¤šä¸ªç³»ç»Ÿå†²çª
    let beamMode = 'none'; // 'none' | 'all' | 'single'
    let activeBeamTimeouts = [];

    // æ¸…é™¤æ‰€æœ‰å…‰æŸçš„è¾…åŠ©å‡½æ•°
    function clearAllBeams() {
      console.log('æ¸…é™¤æ‰€æœ‰å…‰æŸ');
      // æ¸…é™¤æ‰€æœ‰å¾…æ‰§è¡Œçš„æ¿€æ´»åŠ¨ç”»
      activeBeamTimeouts.forEach(timeout => clearTimeout(timeout));
      activeBeamTimeouts = [];
      // ç§»é™¤æ‰€æœ‰activeç±»
      beamGroups.forEach(group => {
        group.classList.remove('active');
      });
    }

    // è°ƒè¯•ï¼šæ‰“å°å½“å‰å…‰æŸçŠ¶æ€
    function logBeamState() {
      const activeBeams = [];
      beamGroups.forEach(group => {
        const id = group.getAttribute('data-beam-id');
        if (group.classList.contains('active')) {
          activeBeams.push(id);
        }
      });
      console.log(`[å…‰æŸçŠ¶æ€] æ¨¡å¼: ${beamMode}, æ¿€æ´»çš„å…‰æŸ: [${activeBeams.join(', ')}]`);
    }

    // ä¸­å¿ƒå»ºç­‘ hoverï¼šæ˜¾ç¤ºæ‰€æœ‰å…‰æŸ
    if (coreBeacon) {
      coreBeacon.addEventListener('mouseenter', () => {
        console.log('é¼ æ ‡è¿›å…¥ä¸­å¿ƒå»ºç­‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰å…‰æŸ');
        clearAllBeams(); // å…ˆæ¸…é™¤æ‰€æœ‰å…‰æŸ
        beamMode = 'all';
        beamGroups.forEach((group, index) => {
          const timeout = setTimeout(() => {
            if (beamMode === 'all') { // åªæœ‰åœ¨ä»å¤„äº 'all' æ¨¡å¼æ—¶æ‰æ¿€æ´»
              group.classList.add('active');
              if (index === beamGroups.length - 1) {
                // æœ€åä¸€æ¡å…‰æŸæ¿€æ´»åï¼Œæ‰“å°çŠ¶æ€
                setTimeout(() => logBeamState(), 50);
              }
            }
          }, index * 80);
          activeBeamTimeouts.push(timeout);
        });
      });

      coreBeacon.addEventListener('mouseleave', () => {
        console.log('é¼ æ ‡ç¦»å¼€ä¸­å¿ƒå»ºç­‘ï¼Œéšè—æ‰€æœ‰å…‰æŸ');
        beamMode = 'none';
        clearAllBeams();
        logBeamState();
      });
    }

  function scaleCanvas() {
    const viewportW = window.innerWidth;
    const viewportH = window.innerHeight;

    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä¿æŒå®½é«˜æ¯”ï¼‰
    const scale = Math.min(viewportW / DESIGN_W, viewportH / DESIGN_H);

    // åº”ç”¨ç¼©æ”¾å˜æ¢ï¼ˆtranslate(-50%, -50%) å±…ä¸­ï¼Œç„¶å scaleï¼‰
    if (mapCanvas) {
      mapCanvas.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }
  }

  // åˆå§‹ç¼©æ”¾
  scaleCanvas();

  // çª—å£è°ƒæ•´æ—¶é‡æ–°ç¼©æ”¾
  window.addEventListener('resize', scaleCanvas);

  // Debug åˆ‡æ¢
  let debugHighlight = false;

  // ğŸ› å¢å¼ºçš„è°ƒè¯•ç³»ç»Ÿï¼šè¯Šæ–­å®¹å™¨å¯è§æ€§
  function diagnoseContainers() {
    console.log('\n========== ğŸ› å®¹å™¨è¯Šæ–­æŠ¥å‘Š ==========\n');

    // è¯Šæ–­æ‰€æœ‰ building å®¹å™¨
    const buildingContainers = document.querySelectorAll('.building-container');
    console.log(`ğŸ“¦ æ‰¾åˆ° ${buildingContainers.length} ä¸ª building å®¹å™¨:\n`);

    buildingContainers.forEach((container, index) => {
      const id = container.getAttribute('data-landmark-id') || container.getAttribute('data-building-id') || `container-${index}`;
      const rect = container.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(container);

      console.log(`[${index + 1}] ${id}:`);
      console.log(`  âœ“ childCount: ${container.children.length}`);
      console.log(`  âœ“ getBoundingClientRect:`, {
        x: rect.x.toFixed(2),
        y: rect.y.toFixed(2),
        width: rect.width.toFixed(2),
        height: rect.height.toFixed(2),
        visible: rect.width > 0 && rect.height > 0
      });
      console.log(`  âœ“ è®¡ç®—æ ·å¼:`, {
        display: computedStyle.display,
        visibility: computedStyle.visibility,
        opacity: computedStyle.opacity,
        zIndex: computedStyle.zIndex,
        overflow: computedStyle.overflow,
        position: computedStyle.position
      });

      // æ£€æŸ¥å­å…ƒç´ ï¼ˆå›¾ç‰‡ï¼‰
      const img = container.querySelector('img');
      if (img) {
        const imgRect = img.getBoundingClientRect();
        const imgStyle = window.getComputedStyle(img);
        console.log(`  âœ“ å­å›¾ç‰‡:`, {
          src: img.src,
          naturalWidth: img.naturalWidth,
          naturalHeight: img.naturalHeight,
          displayWidth: imgRect.width.toFixed(2),
          displayHeight: imgRect.height.toFixed(2),
          opacity: imgStyle.opacity,
          visibility: imgStyle.visibility,
          zIndex: imgStyle.zIndex
        });
      } else {
        console.warn(`  âš ï¸ å®¹å™¨å†…æ²¡æœ‰ img å…ƒç´ ï¼`);
      }
      console.log('');
    });

    // è¯Šæ–­æ‰€æœ‰ sign å®¹å™¨
    const signContainers = document.querySelectorAll('.sign-container');
    console.log(`ğŸ“¦ æ‰¾åˆ° ${signContainers.length} ä¸ª sign å®¹å™¨:\n`);

    signContainers.forEach((container, index) => {
      const id = container.getAttribute('data-landmark-id') || `sign-${index}`;
      const rect = container.getBoundingClientRect();
      const computedStyle = window.getComputedStyle(container);

      console.log(`[${index + 1}] ${id}:`);
      console.log(`  âœ“ childCount: ${container.children.length}`);
      console.log(`  âœ“ getBoundingClientRect:`, {
        x: rect.x.toFixed(2),
        y: rect.y.toFixed(2),
        width: rect.width.toFixed(2),
        height: rect.height.toFixed(2),
        visible: rect.width > 0 && rect.height > 0
      });
      console.log(`  âœ“ è®¡ç®—æ ·å¼:`, {
        display: computedStyle.display,
        visibility: computedStyle.visibility,
        opacity: computedStyle.opacity,
        zIndex: computedStyle.zIndex,
        overflow: computedStyle.overflow
      });

      // æ£€æŸ¥å­å…ƒç´ ï¼ˆå›¾ç‰‡ï¼‰
      const img = container.querySelector('img');
      if (img) {
        const imgRect = img.getBoundingClientRect();
        const imgStyle = window.getComputedStyle(img);
        console.log(`  âœ“ å­å›¾ç‰‡:`, {
          src: img.src,
          naturalWidth: img.naturalWidth,
          naturalHeight: img.naturalHeight,
          displayWidth: imgRect.width.toFixed(2),
          displayHeight: imgRect.height.toFixed(2),
          opacity: imgStyle.opacity,
          visibility: imgStyle.visibility,
          zIndex: imgStyle.zIndex
        });
      } else {
        console.warn(`  âš ï¸ å®¹å™¨å†…æ²¡æœ‰ img å…ƒç´ ï¼`);
      }
      console.log('');
    });

    // æ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–å…ƒç´ é®æŒ¡
    console.log('ğŸ” æ£€æŸ¥å…ƒç´ å±‚çº§å…³ç³»:');
    const allContainers = [...buildingContainers, ...signContainers];
    allContainers.forEach(container => {
      const rect = container.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const topElement = document.elementFromPoint(centerX, centerY);

      const id = container.getAttribute('data-landmark-id') || container.getAttribute('data-building-id') || 'unknown';

      if (topElement && !container.contains(topElement)) {
        console.warn(`  âš ï¸ ${id} è¢«é®æŒ¡ï¼é¡¶å±‚å…ƒç´ :`, topElement.tagName, topElement.className);
      } else {
        console.log(`  âœ“ ${id} å¯è§ï¼ˆæˆ–å®¹å™¨æœ¬èº«åœ¨é¡¶å±‚ï¼‰`);
      }
    });

    console.log('\n========================================\n');
  }

  // é”®ç›˜å¿«æ·é”®ï¼šD é”®åˆ‡æ¢ debug é«˜äº®æ¨¡å¼
  document.addEventListener('keydown', (e) => {
    if (e.key === 'd' || e.key === 'D') {
      debugHighlight = !debugHighlight;

      if (debugHighlight) {
        document.body.classList.add('debug-highlight');
        console.log('ğŸ› Debug é«˜äº®æ¨¡å¼ï¼šå·²å¼€å¯');
        console.log('   - çº¢è‰²è¾¹æ¡†ï¼šå®¹å™¨');
        console.log('   - ç»¿è‰²è¾¹æ¡†ï¼šå›¾ç‰‡');
        console.log('   - z-index å·²å¼ºåˆ¶æå‡åˆ° 9999');

        // æ‰§è¡Œå®Œæ•´è¯Šæ–­
        setTimeout(() => {
          diagnoseContainers();
        }, 100);
      } else {
        document.body.classList.remove('debug-highlight');
        console.log('ğŸ› Debug é«˜äº®æ¨¡å¼ï¼šå·²å…³é—­');
      }
    }
  });

  // æ—§çš„ debug toggleï¼ˆå…¼å®¹æ€§ä¿ç•™ï¼‰
  if (debugToggle && debugLayer) {
    debugToggle.addEventListener('click', () => {
      debugMode = !debugMode;
      debugToggle.classList.toggle('active', debugMode);
      debugLayer.classList.toggle('visible', debugMode);

      if (debugMode) {
        console.log('=== Debug Mode Enabled ===');
        console.log(`Canvas Size: ${DESIGN_W}x${DESIGN_H}`);
        printLandmarkCoordinates();
      }
    });

    // é”®ç›˜å¿«æ·é”®ï¼šD é”®åˆ‡æ¢ debug
    document.addEventListener('keydown', (e) => {
      if (e.key === 'd' || e.key === 'D') {
        debugToggle.click();
      }
    });
  }

  // æ‰“å°åœ°æ ‡åæ ‡
  function printLandmarkCoordinates() {
    const landmarks = document.querySelectorAll('.landmark-group');
    const coreContainer = document.querySelector('.core-container');

    console.log('--- Core Building ---');
    if (coreContainer) {
      const style = coreContainer.style;
      console.log(`  rect: { x: ${style.left}, y: ${style.top}, w: ${style.width}, h: ${style.height} }`);
      console.log(`  transform: ${style.transform}`);
    }

    console.log('\n--- Landmarks ---');
    landmarks.forEach(group => {
      const id = group.getAttribute('data-landmark-id');
      const style = group.style;
      console.log(`${id}:`);
      console.log(`  rect: { x: ${style.left}, y: ${style.top}, w: ${style.width}, h: ${style.height} }`);
      console.log(`  transform: ${style.transform}`);
    });
  }

  // åœ°æ ‡äº¤äº’ï¼ˆåŸºäºæ–°çš„åˆ†å±‚ç»“æ„ï¼‰
  const hotspotContainers = document.querySelectorAll('.landmark-hotspot-container');

  hotspotContainers.forEach(container => {
    const landmarkId = container.getAttribute('data-landmark-id');
    const hotspot = container.querySelector('.landmark-hotspot');
    const buildingContainer = document.querySelector(`[data-landmark-id="${landmarkId}-building"]`);
    const signContainer = document.querySelector(`[data-landmark-id="${landmarkId}-sign"]`);
    const correspondingBeam = document.querySelector(`.beam-group[data-beam-id="${landmarkId}"]`);

    // ä¿å­˜å»ºç­‘å’Œæ ‡ç‰ŒåŸå§‹ transform
    let originalBuildingTransform = '';
    let originalSignTransform = '';
    if (buildingContainer) {
      originalBuildingTransform = buildingContainer.style.transform;
    }
    if (signContainer) {
      originalSignTransform = signContainer.style.transform;
    }

    // Hover äº¤äº’ï¼ˆå»ºç­‘æµ®èµ· + æ ‡ç‰Œæµ®èµ· + æ˜¾ç¤ºå¯¹åº”å…‰æŸï¼‰
    container.addEventListener('mouseenter', () => {
      console.log(`[${landmarkId}] é¼ æ ‡è¿›å…¥å»ºç­‘`);

      // å»ºç­‘æµ®èµ·åŠ¨ç”»ï¼ˆåœ¨åŸæœ‰ transform åŸºç¡€ä¸Šæ·»åŠ æµ®èµ·æ•ˆæœï¼‰
      if (buildingContainer) {
        const landmark = landmarks.find(l => l.id === landmarkId);
        if (landmark) {
          const dx = landmark.building.transform.dx;
          const dy = landmark.building.transform.dy - 6; // å‘ä¸Šæµ®èµ· 6px
          // ä½¿ç”¨é…ç½®çš„æ‚¬åœç¼©æ”¾å€æ•°ï¼Œå¦‚æœæœªé…ç½®åˆ™é»˜è®¤ 1.03
          const hoverScaleMultiplier = landmark.building.hoverScale || 1.03;
          const scale = landmark.building.transform.scale * hoverScaleMultiplier;

          // ğŸ› è°ƒè¯•ä¿¡æ¯
          console.log(`[${landmarkId}] å»ºç­‘æ‚¬åœ:`, {
            åŸå§‹scale: landmark.building.transform.scale,
            hoverScaleé…ç½®: landmark.building.hoverScale,
            è®¡ç®—åscale: scale,
            transform: `translate(${dx}px, ${dy}px) scale(${scale})`
          });

          buildingContainer.style.transform = `translate(${dx}px, ${dy}px) scale(${scale})`;
        }

        // æ·»åŠ é˜´å½±åˆ°å»ºç­‘å›¾å±‚
        const img = buildingContainer.querySelector('.building-layer');
        if (img) img.classList.add('hover');
      }

      // æ ‡ç‰Œä¹Ÿæµ®èµ·ï¼ˆå’Œå»ºç­‘åŒæ­¥ï¼‰
      if (signContainer) {
        const landmark = landmarks.find(l => l.id === landmarkId);
        if (landmark) {
          const dx = landmark.sign.transform.dx;
          const dy = landmark.sign.transform.dy - 6; // å‘ä¸Šæµ®èµ· 6px
          // ä½¿ç”¨é…ç½®çš„æ‚¬åœç¼©æ”¾å€æ•°ï¼Œå¦‚æœæœªé…ç½®åˆ™é»˜è®¤ 1.02
          const hoverScaleMultiplier = landmark.sign.hoverScale || 1.02;
          const scale = landmark.sign.transform.scale * hoverScaleMultiplier;
          signContainer.style.transform = `translate(${dx}px, ${dy}px) scale(${scale})`;
        }
      }

      // æ˜¾ç¤ºå¯¹åº”å…‰æŸï¼ˆä½¿ç”¨é›†ä¸­å¼çŠ¶æ€ç®¡ç†ï¼‰
      if (correspondingBeam) {
        console.log(`[${landmarkId}] åˆ‡æ¢åˆ°å•å…‰æŸæ¨¡å¼`);
        beamMode = 'single';
        clearAllBeams(); // å…ˆæ¸…é™¤æ‰€æœ‰å…‰æŸï¼ˆåŒ…æ‹¬å¯èƒ½çš„ä¸­å¿ƒå»ºç­‘æ¿€æ´»çš„å…‰æŸï¼‰
        correspondingBeam.classList.add('active');
        logBeamState();
      }
    });

    container.addEventListener('mouseleave', () => {
      console.log(`[${landmarkId}] é¼ æ ‡ç¦»å¼€å»ºç­‘`);

      // æ¢å¤å»ºç­‘åŸå§‹ transform
      if (buildingContainer) {
        buildingContainer.style.transform = originalBuildingTransform;

        // ç§»é™¤é˜´å½±
        const img = buildingContainer.querySelector('.building-layer');
        if (img) img.classList.remove('hover');
      }

      // æ¢å¤æ ‡ç‰ŒåŸå§‹ transform
      if (signContainer) {
        signContainer.style.transform = originalSignTransform;
      }

      // éšè—å¯¹åº”å…‰æŸ
      if (correspondingBeam && beamMode === 'single') {
        console.log(`[${landmarkId}] éšè—å…‰æŸ`);
        beamMode = 'none';
        clearAllBeams();
        logBeamState();
      }
    });

    // Click äº¤äº’
    if (hotspot) {
      hotspot.addEventListener('click', (e) => {
        const href = hotspot.getAttribute('href');
        if (prefersReducedMotion || !href) {
          return;
        }
        e.preventDefault();
        setTimeout(() => {
          window.location.href = href;
        }, 150);
      });
    }
  });

  // Resume Badge äº¤äº’
  const resumeBadge = document.getElementById('resumeBadge');
  if (resumeBadge) {
    resumeBadge.addEventListener('click', (e) => {
      const href = resumeBadge.getAttribute('href');
      if (prefersReducedMotion || !href) {
        return;
      }
      e.preventDefault();
      setTimeout(() => {
        window.location.href = href;
      }, 150);
    });
  }

  // å¼¹çª—é€»è¾‘
  const popupOverlay = document.getElementById('popup-overlay');
  const popupClose = document.getElementById('popupClose');
  const popupContents = document.querySelectorAll('.popup-content');

  // æ‰“å¼€å¼¹çª—å‡½æ•°
  function openPopup(type) {
    // éšè—æ‰€æœ‰å¼¹çª—å†…å®¹
    popupContents.forEach(content => {
      content.classList.remove('active');
    });

    // æ˜¾ç¤ºå¯¹åº”çš„å¼¹çª—å†…å®¹
    const targetContent = document.getElementById(`popup-${type}`);
    if (targetContent) {
      targetContent.classList.add('active');
    }

    // æ˜¾ç¤ºå¼¹çª—é®ç½©
    popupOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  // å…³é—­å¼¹çª—å‡½æ•°
  function closePopup() {
    popupOverlay.classList.remove('active');
    document.body.style.overflow = '';
  }

  // ä¸ºç¤¾äº¤å›¾æ ‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
  const socialIcons = document.querySelectorAll('.social-icon[data-popup]');
  socialIcons.forEach(icon => {
    icon.addEventListener('click', (e) => {
      e.preventDefault();
      const popupType = icon.getAttribute('data-popup');
      if (popupType) {
        openPopup(popupType);
      }
    });
  });

  // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  if (popupClose) {
    popupClose.addEventListener('click', closePopup);
  }

  // ç‚¹å‡»é®ç½©å…³é—­å¼¹çª—
  if (popupOverlay) {
    popupOverlay.addEventListener('click', (e) => {
      if (e.target === popupOverlay) {
        closePopup();
      }
    });
  }

  // ESC é”®å…³é—­å¼¹çª—
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && popupOverlay.classList.contains('active')) {
      closePopup();
    }
  });

  // å¤åˆ¶æŒ‰é’®åŠŸèƒ½
  const copyButtons = document.querySelectorAll('.popup-copy-btn');
  copyButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const textToCopy = btn.getAttribute('data-copy');
      const copyText = btn.querySelector('.copy-text');
      const originalText = copyText.textContent;

      try {
        await navigator.clipboard.writeText(textToCopy);

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
        btn.classList.add('copied');
        copyText.textContent = 'å·²å¤åˆ¶';

        // 2ç§’åæ¢å¤åŸçŠ¶
        setTimeout(() => {
          btn.classList.remove('copied');
          copyText.textContent = originalText;
        }, 2000);
      } catch (err) {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        copyText.textContent = 'å¤åˆ¶å¤±è´¥';
        setTimeout(() => {
          copyText.textContent = originalText;
        }, 2000);
      }
    });
  });

  }); // ç»“æŸ astro:page-load
</script>
